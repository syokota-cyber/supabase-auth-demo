<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabaseèªè¨¼ãƒ‡ãƒ¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="max-w-4xl w-full space-y-8 p-8">
        <h1 class="text-3xl font-bold text-center text-gray-900">Supabase èªè¨¼ãƒ†ã‚¹ãƒˆ</h1>
    
    <div id="auth-form" class="bg-white p-8 rounded-lg shadow-md text-center">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ã‚ˆã†ã“ãï¼</h2>
        <p class="text-gray-600 mb-6">TODOã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
        <button onclick="openLoginModal()" 
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg">
            ãƒ­ã‚°ã‚¤ãƒ³ / ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
        </button>
    </div>
    
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full relative">
            <button onclick="closeLoginModal()" 
                    class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">
                Ã—
            </button>
            <h3 class="text-xl font-semibold text-gray-700 mb-6">ãƒ­ã‚°ã‚¤ãƒ³/ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</h3>
            <div id="modal-message" class="text-sm mb-4"></div>
            <div class="space-y-4">
                <input type="email" id="modal-email" placeholder="test@example.com" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="modal-password" placeholder="test1234"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="space-y-2 mt-6">
                <button onclick="modalSignIn()" class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button onclick="modalSignUp()" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</button>
            </div>
        </div>
    </div>

    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="reset-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</h3>
            <div id="reset-message" class="text-sm mb-4"></div>
            
            <!-- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="reset-email-form">
                <p class="text-gray-600 mb-4">ç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”¨ã®ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã¾ã™ã€‚</p>
                <input type="email" id="reset-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <div class="flex space-x-2">
                    <button onclick="sendResetEmail()" 
                            id="send-reset-button"
                            class="flex-1 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                        é€ä¿¡
                    </button>
                    <button onclick="closeResetModal()" 
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </div>
            
            <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‹ã‚‰é–‹ã„ãŸæ™‚ç”¨ï¼‰ -->
            <div id="update-password-form" style="display:none;">
                <p class="text-gray-600 mb-4">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <input type="password" id="new-password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <input type="password" id="confirm-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <div class="flex space-x-2">
                    <button onclick="updatePassword()" 
                            id="update-password-button"
                            class="flex-1 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
                    </button>
                    <button onclick="closeResetModal()" 
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TODOç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="edit-todo-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">TODOç·¨é›†</h3>
            <div id="edit-todo-message" class="text-sm mb-4"></div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="edit-todo-title" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="edit-todo-category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="general">ä¸€èˆ¬</option>
                        <option value="work">ä»•äº‹</option>
                        <option value="private">ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</option>
                        <option value="shopping">è²·ã„ç‰©</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å„ªå…ˆåº¦</label>
                    <select id="edit-todo-priority" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="3">é«˜</option>
                        <option value="2">ä¸­</option>
                        <option value="1">ä½</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æœŸé™</label>
                    <input type="date" id="edit-todo-due-date" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="flex space-x-2 mt-6">
                <button onclick="updateTodo()" 
                        id="update-todo-button"
                        class="flex-1 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    æ›´æ–°
                </button>
                <button onclick="closeEditTodoModal()" 
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="profile-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h3>
            <div id="profile-message" class="text-sm mb-4"></div>
            
            <div class="space-y-4">
                <!-- ã‚¢ãƒã‚¿ãƒ¼é¸æŠ -->
                <div class="text-center">
                    <div class="w-20 h-20 bg-gray-300 rounded-full overflow-hidden flex items-center justify-center text-3xl mx-auto mb-2 border-2 border-gray-300">
                        <img id="profile-avatar-preview-img" src="" alt="Avatar" class="w-full h-full object-cover hidden">
                        <span id="profile-avatar-preview-text">ğŸ‘¤</span>
                    </div>
                    <label class="text-sm text-blue-600 cursor-pointer hover:text-blue-800">
                        ç”»åƒã‚’é¸æŠ
                        <input type="file" id="avatar-input" accept="image/*" class="hidden">
                    </label>
                    <p class="text-xs text-gray-500 mt-1">JPG, PNG, GIF (æœ€å¤§2MB)</p>
                </div>
                
                <!-- è¡¨ç¤ºå -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¡¨ç¤ºå</label>
                    <input type="text" id="profile-display-name" placeholder="è¡¨ç¤ºåã‚’å…¥åŠ›" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- è‡ªå·±ç´¹ä»‹ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è‡ªå·±ç´¹ä»‹</label>
                    <textarea id="profile-bio" placeholder="è‡ªå·±ç´¹ä»‹ã‚’å…¥åŠ›" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <!-- ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</label>
                    <input type="url" id="profile-website" placeholder="https://example.com" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="flex space-x-2 mt-6">
                <button onclick="saveProfile()" 
                        id="save-profile-button"
                        class="flex-1 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                    ä¿å­˜
                </button>
                <button onclick="closeProfileModal()" 
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </div>
    </div>
    
    <div id="user-info" style="display:none;" class="bg-white p-8 rounded-lg shadow-md">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
            
            <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-400 to-blue-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="total-todos">0</div>
                    <div class="text-sm opacity-80">ç·TODOæ•°</div>
                </div>
                <div class="bg-gradient-to-br from-green-400 to-green-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="completed-todos">0</div>
                    <div class="text-sm opacity-80">å®Œäº†æ¸ˆã¿</div>
                </div>
                <div class="bg-gradient-to-br from-red-400 to-red-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="overdue-todos">0</div>
                    <div class="text-sm opacity-80">æœŸé™åˆ‡ã‚Œ</div>
                </div>
                <div class="bg-gradient-to-br from-purple-400 to-purple-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="high-priority-todos">0</div>
                    <div class="text-sm opacity-80">é«˜å„ªå…ˆåº¦</div>
                </div>
            </div>
            
            <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-semibold text-gray-700">ã‚«ãƒ†ã‚´ãƒªåˆ¥</h4>
                        <button onclick="switchCategoryChart()" 
                                class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded">
                            åˆ‡æ›¿
                        </button>
                    </div>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-semibold text-gray-700">å„ªå…ˆåº¦åˆ¥</h4>
                        <button onclick="switchPriorityChart()" 
                                class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded">
                            åˆ‡æ›¿
                        </button>
                    </div>
                    <canvas id="priorityChart"></canvas>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-semibold text-gray-700">é€²æ—çŠ¶æ³</h4>
                        <button onclick="switchStatusChart()" 
                                class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded">
                            åˆ‡æ›¿
                        </button>
                    </div>
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            
            <div class="bg-blue-50 p-6 rounded-lg mb-4">
                <div class="flex items-center space-x-4 mb-4">
                    <div class="w-16 h-16 bg-gray-300 rounded-full overflow-hidden flex items-center justify-center text-2xl border-2 border-gray-300">
                        <img id="user-avatar-img" src="" alt="Avatar" class="w-full h-full object-cover hidden">
                        <span id="user-avatar-text">ğŸ‘¤</span>
                    </div>
                    <div class="flex-1">
                        <h3 id="user-display-name" class="text-xl font-semibold text-gray-800">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</h3>
                        <p id="user-email" class="text-gray-600"></p>
                    </div>
                    <button onclick="openProfileModal()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                        ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
                    </button>
                </div>
                <div class="border-t pt-4 space-y-2">
                    <p id="user-bio" class="text-gray-700 text-sm italic">è‡ªå·±ç´¹ä»‹ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    <div class="grid grid-cols-2 gap-4 text-xs text-gray-500">
                        <div>
                            <strong>ç™»éŒ²æ—¥:</strong>
                            <span id="user-created"></span>
                        </div>
                        <div>
                            <strong>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³:</strong>
                            <span id="user-last-signin"></span>
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="signOut()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        
        <!-- TODOå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">æ–°ã—ã„TODO</h3>
            <div class="space-y-2">
                <input type="text" id="todo-input" placeholder="TODOã‚’å…¥åŠ›..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex space-x-2">
                    <select id="todo-category" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="general">ä¸€èˆ¬</option>
                        <option value="work">ä»•äº‹</option>
                        <option value="private">ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</option>
                        <option value="shopping">è²·ã„ç‰©</option>
                    </select>
                    <select id="todo-priority" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="3">é«˜</option>
                        <option value="2" selected>ä¸­</option>
                        <option value="1">ä½</option>
                    </select>
                    <input type="date" id="todo-due-date" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="addTodo()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">è¿½åŠ </button>
                </div>
            </div>
        </div>
        
        <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿</h3>
            <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                <!-- æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ -->
                <div class="flex space-x-2 mb-3">
                    <button onclick="filterByPeriod('all')" 
                            class="period-btn flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-blue-50 focus:bg-blue-100 focus:border-blue-500"
                            data-period="all">
                        å…¨æœŸé–“
                    </button>
                    <button onclick="filterByPeriod('today')" 
                            class="period-btn flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-blue-50 focus:bg-blue-100 focus:border-blue-500"
                            data-period="today">
                        ä»Šæ—¥
                    </button>
                    <button onclick="filterByPeriod('week')" 
                            class="period-btn flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-blue-50 focus:bg-blue-100 focus:border-blue-500"
                            data-period="week">
                        ä»Šé€±
                    </button>
                    <button onclick="filterByPeriod('month')" 
                            class="period-btn flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-blue-50 focus:bg-blue-100 focus:border-blue-500"
                            data-period="month">
                        ä»Šæœˆ
                    </button>
                </div>
                
                <input type="text" id="search-input" placeholder="TODOã‚’æ¤œç´¢..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex space-x-2">
                    <select id="filter-category" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
                        <option value="general">ä¸€èˆ¬</option>
                        <option value="work">ä»•äº‹</option>
                        <option value="private">ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</option>
                        <option value="shopping">è²·ã„ç‰©</option>
                    </select>
                    <select id="filter-priority" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ã™ã¹ã¦ã®å„ªå…ˆåº¦</option>
                        <option value="3">é«˜</option>
                        <option value="2">ä¸­</option>
                        <option value="1">ä½</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- TODOãƒªã‚¹ãƒˆè¡¨ç¤º -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">TODOãƒªã‚¹ãƒˆ</h3>
            <div id="todo-list" class="space-y-2">
                <!-- TODOã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script>
        // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
        const supabaseUrl = 'https://quxokigryvzksexhbpbm.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1eG9raWdyeXZ6a3NleGhicGJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNTY5MTEsImV4cCI6MjA2ODczMjkxMX0.OEVIN34m7pnhrGO9tZ8wBxHNaNL7OCC0REpQOs6JjAQ'
        
        // TODOãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let allTodos = []
        
        // ã‚°ãƒ©ãƒ•ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let categoryChart = null
        let priorityChart = null
        let statusChart = null
        
        // ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—ã‚’ç®¡ç†ã™ã‚‹å¤‰æ•°
        let categoryChartType = 'doughnut'  // åˆæœŸã¯å††ã‚°ãƒ©ãƒ•
        let priorityChartType = 'bar'       // åˆæœŸã¯æ£’ã‚°ãƒ©ãƒ•
        let statusChartType = 'doughnut'    // åˆæœŸã¯å††ã‚°ãƒ©ãƒ•
        
        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®TODO IDã‚’ä¿æŒ
        let draggedTodoId = null
        
        // ç·¨é›†ä¸­ã®TODO IDã‚’ä¿æŒ
        let editingTodoId = null
        
        // ç¾åœ¨ã®æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        let currentPeriod = 'all'
        
        // å®Œå…¨ã«ã‚¯ãƒªãƒ¼ãƒ³ãªSupabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                detectSessionInUrl: false,
                persistSession: false,
                autoRefreshToken: false,
                flowType: 'implicit'
            },
            global: {
                headers: {
                    'x-custom-header': 'local-dev'
                }
            }
        })

        // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
        async function signUp() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!email || !password) {
                showMessage('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true)
                return
            }
            
            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
            if (!isValidEmail(email)) {
                showMessage('æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„', true)
                return
            }
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®é•·ã•ãƒã‚§ãƒƒã‚¯
            if (password.length < 6) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', true)
                return
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            hideMessage()
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
            setLoading(true)
            
            try {
                console.log('ç¾åœ¨ã®URL:', window.location.origin)
                console.log('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹')
                
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password
                })
                
                console.log('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', { data, error })
                
                if (error) {
                    console.error('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼è©³ç´°:', error)
                    showMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, true)
                } else {
                    showMessage('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æˆåŠŸï¼ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„', false)
                    // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
                    setTimeout(hideMessage, 3000)
                }
            } finally {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
                setLoading(false)
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°ï¼ˆã‚¨ãƒ©ãƒ¼ã¨æˆåŠŸä¸¡æ–¹ã«å¯¾å¿œï¼‰
        function showMessage(message, isError = true) {
            const messageDiv = document.getElementById('message')
            messageDiv.textContent = message
            messageDiv.className = isError ? 'text-red-500 text-sm mb-4' : 'text-green-500 text-sm mb-4'
            messageDiv.style.display = 'block'
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éè¡¨ç¤ºé–¢æ•°
        function hideMessage() {
            const messageDiv = document.getElementById('message')
            messageDiv.textContent = ''
            messageDiv.style.display = 'none'
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ç®¡ç†
        function setLoading(isLoading) {
            const signupButton = document.getElementById('signup-button')
            const signinButton = document.getElementById('signin-button')
            
            if (isLoading) {
                signupButton.disabled = true
                signinButton.disabled = true
                signupButton.textContent = 'å‡¦ç†ä¸­...'
                signinButton.textContent = 'å‡¦ç†ä¸­...'
            } else {
                signupButton.disabled = false
                signinButton.disabled = false
                signupButton.textContent = 'ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—'
                signinButton.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³'
            }
        }
        
        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
        function isValidEmail(email) {
            // åŸºæœ¬çš„ãªãƒ¡ãƒ¼ãƒ«å½¢å¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
            return emailPattern.test(email)
        }
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password')
            const toggleIcon = document.getElementById('password-toggle-icon')
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text'
                toggleIcon.textContent = 'ğŸ™ˆ'
            } else {
                passwordInput.type = 'password'
                toggleIcon.textContent = 'ğŸ‘ï¸'
            }
        }
        
        // ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openResetModal() {
            const modal = document.getElementById('reset-modal')
            modal.classList.remove('hidden')
            document.getElementById('reset-email').value = ''
            hideResetMessage()
        }
        
        // ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeResetModal() {
            const modal = document.getElementById('reset-modal')
            modal.classList.add('hidden')
            hideResetMessage()
        }
        
        // ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showResetMessage(message, isError = true) {
            const messageDiv = document.getElementById('reset-message')
            messageDiv.textContent = message
            messageDiv.className = isError ? 'text-red-500 text-sm mb-4' : 'text-green-500 text-sm mb-4'
            messageDiv.style.display = 'block'
        }
        
        // ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éè¡¨ç¤º
        function hideResetMessage() {
            const messageDiv = document.getElementById('reset-message')
            messageDiv.textContent = ''
            messageDiv.style.display = 'none'
        }
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡
        async function sendResetEmail() {
            const email = document.getElementById('reset-email').value
            
            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!email) {
                showResetMessage('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true)
                return
            }
            
            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
            if (!isValidEmail(email)) {
                showResetMessage('æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„', true)
                return
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
            const sendButton = document.getElementById('send-reset-button')
            sendButton.disabled = true
            sendButton.textContent = 'é€ä¿¡ä¸­...'
            
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/index.html'
                })
                
                if (error) {
                    console.error('ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error)
                    showResetMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, true)
                } else {
                    showResetMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚', false)
                    // 5ç§’å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    setTimeout(() => {
                        closeResetModal()
                    }, 5000)
                }
            } finally {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
                sendButton.disabled = false
                sendButton.textContent = 'é€ä¿¡'
            }
        }
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°æ©Ÿèƒ½
        async function updatePassword() {
            const newPassword = document.getElementById('new-password').value
            const confirmPassword = document.getElementById('confirm-password').value
            
            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!newPassword || !confirmPassword) {
                showResetMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true)
                return
            }
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®é•·ã•ãƒã‚§ãƒƒã‚¯
            if (newPassword.length < 6) {
                showResetMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', true)
                return
            }
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒã‚§ãƒƒã‚¯
            if (newPassword !== confirmPassword) {
                showResetMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', true)
                return
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
            const updateButton = document.getElementById('update-password-button')
            updateButton.disabled = true
            updateButton.textContent = 'æ›´æ–°ä¸­...'
            
            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                })
                
                if (error) {
                    console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error)
                    showResetMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, true)
                } else {
                    showResetMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼', false)
                    // 3ç§’å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    setTimeout(() => {
                        closeResetModal()
                        location.reload() // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’åæ˜ 
                    }, 3000)
                }
            } finally {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
                updateButton.disabled = false
                updateButton.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°'
            }
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°
        function openProfileModal() {
            const modal = document.getElementById('profile-modal')
            modal.classList.remove('hidden')
            loadCurrentProfile()
            hideProfileMessage()
        }
        
        function closeProfileModal() {
            const modal = document.getElementById('profile-modal')
            modal.classList.add('hidden')
            hideProfileMessage()
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showProfileMessage(message, isError = true) {
            const messageDiv = document.getElementById('profile-message')
            messageDiv.textContent = message
            messageDiv.className = isError ? 'text-red-500 text-sm mb-4' : 'text-green-500 text-sm mb-4'
            messageDiv.style.display = 'block'
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éè¡¨ç¤º
        function hideProfileMessage() {
            const messageDiv = document.getElementById('profile-message')
            messageDiv.textContent = ''
            messageDiv.style.display = 'none'
        }
        
        // ç¾åœ¨ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
        async function loadCurrentProfile() {
            try {
                const { data: { user } } = await supabase.auth.getUser()
                if (user && user.user_metadata) {
                    const metadata = user.user_metadata
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®å€¤ã‚’è¨­å®š
                    document.getElementById('profile-display-name').value = metadata.display_name || ''
                    document.getElementById('profile-bio').value = metadata.bio || ''
                    document.getElementById('profile-website').value = metadata.website || ''
                    
                    // ã‚¢ãƒã‚¿ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
                    const previewImg = document.getElementById('profile-avatar-preview-img')
                    const previewText = document.getElementById('profile-avatar-preview-text')
                    
                    if (metadata.avatar_type === 'image' && metadata.avatar) {
                        previewImg.src = metadata.avatar
                        previewImg.classList.remove('hidden')
                        previewText.classList.add('hidden')
                        window.selectedAvatarData = metadata.avatar
                    } else {
                        previewText.textContent = metadata.avatar || 'ğŸ‘¤'
                        previewImg.classList.add('hidden')
                        previewText.classList.remove('hidden')
                        window.selectedAvatarData = null
                    }
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error)
            }
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜æ©Ÿèƒ½
        async function saveProfile() {
            const displayName = document.getElementById('profile-display-name').value.trim()
            const bio = document.getElementById('profile-bio').value.trim()
            const website = document.getElementById('profile-website').value.trim()
            
            // è¡¨ç¤ºåã®å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!displayName) {
                showProfileMessage('è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true)
                return
            }
            
            // ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆURLã®å½¢å¼ãƒã‚§ãƒƒã‚¯
            if (website && !isValidUrl(website)) {
                showProfileMessage('æ­£ã—ã„URLå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„', true)
                return
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
            const saveButton = document.getElementById('save-profile-button')
            saveButton.disabled = true
            saveButton.textContent = 'ä¿å­˜ä¸­...'
            
            try {
                // ã‚¢ãƒã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆç”»åƒã¾ãŸã¯çµµæ–‡å­—ï¼‰
                const avatarData = window.selectedAvatarData || document.getElementById('profile-avatar-preview-text').textContent
                
                const { error } = await supabase.auth.updateUser({
                    data: {
                        display_name: displayName,
                        bio: bio,
                        website: website,
                        avatar: avatarData,
                        avatar_type: window.selectedAvatarData ? 'image' : 'emoji'
                    }
                })
                
                if (error) {
                    console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error)
                    showProfileMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, true)
                } else {
                    showProfileMessage('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼', false)
                    showNotification('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°å®Œäº†', 'success', 'å¤‰æ›´ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ')
                    
                    // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
                    updateProfileDisplay()
                    
                    // 2ç§’å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    setTimeout(() => {
                        closeProfileModal()
                    }, 2000)
                }
            } finally {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
                saveButton.disabled = false
                saveButton.textContent = 'ä¿å­˜'
            }
        }
        
        // URLå½¢å¼ãƒã‚§ãƒƒã‚¯
        function isValidUrl(string) {
            try {
                new URL(string)
                return true
            } catch (_) {
                return false
            }
        }
        
        // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥æ©Ÿèƒ½
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission()
                return permission === 'granted'
            }
            return false
        }
        
        // é€šçŸ¥ã‚’è¡¨ç¤º
        function showNotification(title, type = 'info', body = '') {
            // ã‚¢ãƒ—ãƒªå†…é€šçŸ¥
            showInAppNotification(title, type, body)
            
            // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥
            if (Notification.permission === 'granted') {
                const options = {
                    body: body,
                    icon: 'ğŸ‘¤', // ç°¡æ˜“ã‚¢ã‚¤ã‚³ãƒ³
                    badge: 'ğŸ“±',
                    tag: 'todo-app-notification'
                }
                
                const iconMap = {
                    'success': 'âœ…',
                    'error': 'âŒ',
                    'warning': 'âš ï¸',
                    'info': 'â„¹ï¸'
                }
                
                options.icon = iconMap[type] || 'ğŸ“±'
                
                const notification = new Notification(title, options)
                
                // 5ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
                setTimeout(() => {
                    notification.close()
                }, 5000)
            }
        }
        
        // ã‚¢ãƒ—ãƒªå†…é€šçŸ¥ï¼ˆç”»é¢å†…ã®ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼‰
        function showInAppNotification(title, type = 'info', body = '') {
            // é€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
            let container = document.getElementById('notification-container')
            if (!container) {
                container = document.createElement('div')
                container.id = 'notification-container'
                container.className = 'fixed top-4 right-4 z-50 space-y-2'
                document.body.appendChild(container)
            }
            
            // é€šçŸ¥è¦ç´ ã‚’ä½œæˆ
            const notification = document.createElement('div')
            notification.className = `p-4 rounded-lg shadow-lg max-w-sm ${getNotificationStyle(type)} transform transition-all duration-300 ease-in-out opacity-0 translate-x-full`
            
            const iconMap = {
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            }
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <span class="text-lg mr-3">${iconMap[type] || 'â„¹ï¸'}</span>
                    <div class="flex-1">
                        <div class="font-medium">${title}</div>
                        ${body ? `<div class="text-sm mt-1">${body}</div>` : ''}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-400 hover:text-gray-600">Ã—</button>
                </div>
            `
            
            container.appendChild(notification)
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
            setTimeout(() => {
                notification.classList.remove('opacity-0', 'translate-x-full')
            }, 100)
            
            // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-x-full')
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove()
                    }
                }, 300)
            }, 5000)
        }
        
        // é€šçŸ¥ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å–å¾—
        function getNotificationStyle(type) {
            const styles = {
                'success': 'bg-green-100 border-green-500 text-green-700',
                'error': 'bg-red-100 border-red-500 text-red-700',
                'warning': 'bg-yellow-100 border-yellow-500 text-yellow-700',
                'info': 'bg-blue-100 border-blue-500 text-blue-700'
            }
            return styles[type] || styles.info
        }

        // ãƒ­ã‚°ã‚¤ãƒ³é–¢æ•°
        async function signIn() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!email || !password) {
                showMessage('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true)
                return
            }
            
            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
            if (!isValidEmail(email)) {
                showMessage('æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„', true)
                return
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            hideMessage()
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
            setLoading(true)
            
            try {
                console.log('ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ:', email)
                
                // ãƒ­ã‚°ã‚¤ãƒ³ã®ã¿ã‚’å®Ÿè¡Œ
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                })
                
                console.log('ãƒ­ã‚°ã‚¤ãƒ³çµæœ:', { data, error })
                
                if (error) {
                    console.error('è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±:', error)
                    showMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, true)
                } else {
                    showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸï¼', false)
                    showNotification('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ', 'success', 'ã‚ˆã†ã“ãï¼')
                    setTimeout(() => {
                        showUserInfo(data.user)
                    }, 1000)
                }
            } finally {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
                setLoading(false)
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–¢æ•°
        async function signOut() {
            await supabase.auth.signOut()
            hideUserInfo()
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
        function showUserInfo(user) {
            document.getElementById('auth-form').style.display = 'none'
            document.getElementById('user-info').style.display = 'block'
            
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
            updateProfileDisplay(user)
            
            loadTodos()
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
        async function updateProfileDisplay(user = null) {
            if (!user) {
                const { data: { user: currentUser } } = await supabase.auth.getUser()
                user = currentUser
            }
            
            if (user) {
                const metadata = user.user_metadata || {}
                
                // åŸºæœ¬æƒ…å ±
                document.getElementById('user-email').textContent = user.email
                document.getElementById('user-created').textContent = new Date(user.created_at).toLocaleDateString('ja-JP')
                document.getElementById('user-last-signin').textContent = new Date(user.last_sign_in_at).toLocaleString('ja-JP')
                
                // ã‚«ã‚¹ã‚¿ãƒ æƒ…å ±
                document.getElementById('user-display-name').textContent = metadata.display_name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å'
                
                // ã‚¢ãƒã‚¿ãƒ¼è¡¨ç¤ºï¼ˆç”»åƒã¾ãŸã¯çµµæ–‡å­—ï¼‰
                const avatarImg = document.getElementById('user-avatar-img')
                const avatarText = document.getElementById('user-avatar-text')
                
                if (metadata.avatar_type === 'image' && metadata.avatar) {
                    avatarImg.src = metadata.avatar
                    avatarImg.classList.remove('hidden')
                    avatarText.classList.add('hidden')
                } else {
                    avatarText.textContent = metadata.avatar || 'ğŸ‘¤'
                    avatarImg.classList.add('hidden')
                    avatarText.classList.remove('hidden')
                }
                
                const bioElement = document.getElementById('user-bio')
                if (metadata.bio) {
                    bioElement.textContent = metadata.bio
                    bioElement.classList.remove('italic')
                } else {
                    bioElement.textContent = 'è‡ªå·±ç´¹ä»‹ãŒã‚ã‚Šã¾ã›ã‚“'
                    bioElement.classList.add('italic')
                }
                
                // ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆãƒªãƒ³ã‚¯ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
                if (metadata.website) {
                    bioElement.innerHTML += `<br><a href="${metadata.website}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs">ğŸŒ ${metadata.website}</a>`
                }
            }
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°é–¢æ•°
        function updateStats(todos) {
            const total = todos.length
            const completed = todos.filter(todo => todo.complete).length
            const overdue = todos.filter(todo => 
                todo.due_date && new Date(todo.due_date) < new Date() && !todo.complete
            ).length
            const highPriority = todos.filter(todo => todo.priority === 3).length
            
            document.getElementById('total-todos').textContent = total
            document.getElementById('completed-todos').textContent = completed
            document.getElementById('overdue-todos').textContent = overdue
            document.getElementById('high-priority-todos').textContent = highPriority
            
            // ã‚°ãƒ©ãƒ•ã‚‚æ›´æ–°
            updateCharts(todos)
        }
        
        // ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿é›†è¨ˆé–¢æ•°
        function updateCharts(todos) {
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥é›†è¨ˆ
            const categoryData = {
                general: todos.filter(t => t.category === 'general').length,
                work: todos.filter(t => t.category === 'work').length,
                private: todos.filter(t => t.category === 'private').length,
                shopping: todos.filter(t => t.category === 'shopping').length
            }
            
            // å„ªå…ˆåº¦åˆ¥é›†è¨ˆ
            const priorityData = {
                high: todos.filter(t => t.priority === 3).length,
                medium: todos.filter(t => t.priority === 2).length,
                low: todos.filter(t => t.priority === 1).length
            }
            
            // é€²æ—çŠ¶æ³åˆ¥é›†è¨ˆ
            const statusData = {
                completed: todos.filter(t => t.complete).length,
                incomplete: todos.filter(t => !t.complete).length
            }
            
            // ã‚°ãƒ©ãƒ•ã‚’æç”»
            drawCharts(categoryData, priorityData, statusData)
        }
        
        // ã‚°ãƒ©ãƒ•æç”»é–¢æ•°
        function drawCharts(categoryData, priorityData, statusData) {
            // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ãŒã‚ã‚Œã°å‰Šé™¤
            if (categoryChart) categoryChart.destroy()
            if (priorityChart) priorityChart.destroy()
            if (statusChart) statusChart.destroy()
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚°ãƒ©ãƒ•
            const categoryCtx = document.getElementById('categoryChart').getContext('2d')
            categoryChart = new Chart(categoryCtx, {
                type: categoryChartType,
                data: {
                    labels: ['ä¸€èˆ¬', 'ä»•äº‹', 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ', 'è²·ã„ç‰©'],
                    datasets: [{
                        data: [categoryData.general, categoryData.work, categoryData.private, categoryData.shopping],
                        backgroundColor: ['#9CA3AF', '#3B82F6', '#10B981', '#8B5CF6']
                    }]
                },
                options: {
                    plugins: { 
                        legend: { display: categoryChartType !== 'bar' }
                    }
                }
            })
            
            // å„ªå…ˆåº¦åˆ¥ã‚°ãƒ©ãƒ•
            const priorityCtx = document.getElementById('priorityChart').getContext('2d')
            priorityChart = new Chart(priorityCtx, {
                type: priorityChartType,
                data: {
                    labels: ['é«˜', 'ä¸­', 'ä½'],
                    datasets: [{
                        data: [priorityData.high, priorityData.medium, priorityData.low],
                        backgroundColor: ['#EF4444', '#F59E0B', '#10B981']
                    }]
                },
                options: {
                    plugins: { 
                        legend: { display: priorityChartType !== 'bar' } 
                    }
                }
            })
            
            // é€²æ—çŠ¶æ³ã‚°ãƒ©ãƒ•
            const statusCtx = document.getElementById('statusChart').getContext('2d')
            statusChart = new Chart(statusCtx, {
                type: statusChartType,
                data: {
                    labels: ['å®Œäº†', 'æœªå®Œäº†'],
                    datasets: [{
                        data: [statusData.completed, statusData.incomplete],
                        backgroundColor: ['#10B981', '#EF4444']
                    }]
                },
                options: {
                    plugins: { 
                        legend: { display: statusChartType !== 'bar' }
                    }
                }
            })
        }
        
        // ã‚«ãƒ†ã‚´ãƒªã‚°ãƒ©ãƒ•åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function switchCategoryChart() {
            const types = ['doughnut', 'bar', 'pie', 'line']
            const currentIndex = types.indexOf(categoryChartType)
            categoryChartType = types[(currentIndex + 1) % types.length]
            
            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã§å†æç”»
            updateCharts(allTodos)
        }
        
        // å„ªå…ˆåº¦ã‚°ãƒ©ãƒ•åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function switchPriorityChart() {
            const types = ['bar', 'doughnut', 'pie', 'line']
            const currentIndex = types.indexOf(priorityChartType)
            priorityChartType = types[(currentIndex + 1) % types.length]
            
            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã§å†æç”»
            updateCharts(allTodos)
        }
        
        // é€²æ—çŠ¶æ³ã‚°ãƒ©ãƒ•åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function switchStatusChart() {
            const types = ['doughnut', 'bar', 'pie', 'line']
            const currentIndex = types.indexOf(statusChartType)
            statusChartType = types[(currentIndex + 1) % types.length]
            
            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã§å†æç”»
            updateCharts(allTodos)
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±éè¡¨ç¤º
        function hideUserInfo() {
            document.getElementById('auth-form').style.display = 'block'
            document.getElementById('user-info').style.display = 'none'
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ç¢ºèªé–¢æ•°
        async function checkUser() {
            const { data: { user }, error } = await supabase.auth.getUser()
            console.log('ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user)
            console.log('ã‚¨ãƒ©ãƒ¼:', error)
            if (user) {
                alert(`ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.email}\nãƒ¡ãƒ¼ãƒ«ç¢ºèª: ${user.email_confirmed_at ? 'ç¢ºèªæ¸ˆã¿' : 'æœªç¢ºèª'}`)
            } else {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“')
            }
        }

        // TODOè¿½åŠ é–¢æ•°
        async function addTodo() {
            const todoInput = document.getElementById('todo-input')
            const categorySelect = document.getElementById('todo-category')
            const prioritySelect = document.getElementById('todo-priority')
            const dueDateInput = document.getElementById('todo-due-date')
            const title = todoInput.value.trim()
            const category = categorySelect.value
            const priority = parseInt(prioritySelect.value)
            const dueDate = dueDateInput.value || null
            
            if (!title) {
                alert('TODOã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
                return
            }
            
            const { data: { user } } = await supabase.auth.getUser()
            
            const { data, error } = await supabase
                .from('todos')
                .insert([
                    { user_id: user.id, title: title, category: category, priority: priority, due_date: dueDate, complete: false }
                ])
            
            if (error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message)
                showNotification('TODOè¿½åŠ ã‚¨ãƒ©ãƒ¼', 'error', error.message)
            } else {
                todoInput.value = ''
                dueDateInput.value = ''
                showNotification('TODOè¿½åŠ å®Œäº†', 'success', 'TODOãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ')
                loadTodos()
            }
        }

        // TODOãƒªã‚¹ãƒˆå–å¾—ãƒ»è¡¨ç¤ºé–¢æ•°
        async function loadTodos() {
            const { data: { user } } = await supabase.auth.getUser()
            
            const { data: todos, error } = await supabase
                .from('todos')
                .select('*')
                .eq('user_id', user.id)
                .order('priority', { ascending: false })
                .order('created_at', { ascending: false })
            
            if (error) {
                console.error('TODOãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error)
                return
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            allTodos = todos
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            displayTodos(todos)
        }
        
        // TODOã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function displayTodos(todos) {
            const todoList = document.getElementById('todo-list')
            todoList.innerHTML = ''
            
            // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
            updateStats(todos)
            
            todos.forEach(todo => {
                const categoryColors = {
                    'general': 'bg-gray-100 text-gray-700',
                    'work': 'bg-blue-100 text-blue-700',
                    'private': 'bg-green-100 text-green-700',
                    'shopping': 'bg-purple-100 text-purple-700'
                }
                const categoryNames = {
                    'general': 'ä¸€èˆ¬',
                    'work': 'ä»•äº‹',
                    'private': 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ',
                    'shopping': 'è²·ã„ç‰©'
                }
                const priorityColors = {
                    3: 'bg-red-100 text-red-700',
                    2: 'bg-yellow-100 text-yellow-700', 
                    1: 'bg-green-100 text-green-700'
                }
                const priorityNames = { 3: 'é«˜', 2: 'ä¸­', 1: 'ä½' }
                
                // æœŸé™åˆ¤å®š
                const isOverdue = todo.due_date && new Date(todo.due_date) < new Date() && !todo.complete
                const dueDateStr = todo.due_date ? new Date(todo.due_date).toLocaleDateString('ja-JP') : ''
                
                const todoItem = document.createElement('div')
                todoItem.className = `flex items-center p-3 rounded-md ${isOverdue ? 'bg-red-50 border-l-4 border-red-400' : 'bg-gray-50'} cursor-move`
                todoItem.draggable = true
                todoItem.dataset.todoId = todo.id
                
                // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                todoItem.addEventListener('dragstart', handleDragStart)
                todoItem.addEventListener('dragover', handleDragOver)
                todoItem.addEventListener('drop', handleDrop)
                todoItem.addEventListener('dragend', handleDragEnd)
                todoItem.innerHTML = `
                    <span class="px-2 py-1 text-xs rounded-full ${priorityColors[todo.priority] || priorityColors[2]} mr-2">
                        ${priorityNames[todo.priority] || 'ä¸­'}
                    </span>
                    <span class="px-2 py-1 text-xs rounded-full ${categoryColors[todo.category] || categoryColors.general} mr-2">
                        ${categoryNames[todo.category] || 'ãã®ä»–'}
                    </span>
                    ${dueDateStr ? `<span class="px-2 py-1 text-xs rounded ${isOverdue ? 'bg-red-200 text-red-800' : 'bg-blue-100 text-blue-700'} mr-2">ğŸ“…${dueDateStr}</span>` : ''}
                    <span class="flex-1 ${todo.complete ? 'line-through text-gray-500' : 'text-gray-800'}">${todo.title}</span>
                    <button onclick="editTodo(${todo.id})" 
                            class="ml-2 px-3 py-1 text-sm rounded bg-blue-500 hover:bg-blue-600 text-white"
                            draggable="false">
                        ç·¨é›†
                    </button>
                    <button onclick="toggleTodo(${todo.id}, ${!todo.complete})" 
                            class="ml-2 px-3 py-1 text-sm rounded ${todo.complete ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white"
                            draggable="false">
                        ${todo.complete ? 'æœªå®Œäº†' : 'å®Œäº†'}
                    </button>
                    <button onclick="deleteTodo(${todo.id})" 
                            class="ml-2 px-3 py-1 text-sm rounded bg-red-500 hover:bg-red-600 text-white"
                            draggable="false">
                        å‰Šé™¤
                    </button>
                `
                todoList.appendChild(todoItem)
            })
        }

        // TODOå®Œäº†/æœªå®Œäº†åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        async function toggleTodo(id, completed) {
            const { data, error } = await supabase
                .from('todos')
                .update({ complete: completed })
                .eq('id', id)
            
            if (error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message)
            } else {
                loadTodos()
            }
        }

        // TODOå‰Šé™¤é–¢æ•°
        async function deleteTodo(id) {
            if (!confirm('ã“ã®TODOã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return
            }
            
            const { data, error } = await supabase
                .from('todos')
                .delete()
                .eq('id', id)
            
            if (error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message)
            } else {
                loadTodos()
            }
        }
        
        // TODOç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function editTodo(id) {
            const todo = allTodos.find(t => t.id === id)
            if (!todo) return
            
            editingTodoId = id
            
            // ç¾åœ¨ã®å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¨­å®š
            document.getElementById('edit-todo-title').value = todo.title
            document.getElementById('edit-todo-category').value = todo.category
            document.getElementById('edit-todo-priority').value = todo.priority
            document.getElementById('edit-todo-due-date').value = todo.due_date || ''
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('edit-todo-modal').classList.remove('hidden')
        }
        
        // TODOç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeEditTodoModal() {
            document.getElementById('edit-todo-modal').classList.add('hidden')
            editingTodoId = null
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('edit-todo-message').textContent = ''
        }
        
        // TODOæ›´æ–°é–¢æ•°
        async function updateTodo() {
            if (!editingTodoId) return
            
            const title = document.getElementById('edit-todo-title').value.trim()
            const category = document.getElementById('edit-todo-category').value
            const priority = parseInt(document.getElementById('edit-todo-priority').value)
            const dueDate = document.getElementById('edit-todo-due-date').value || null
            
            if (!title) {
                document.getElementById('edit-todo-message').textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'
                document.getElementById('edit-todo-message').className = 'text-red-500 text-sm mb-4'
                return
            }
            
            const { data, error } = await supabase
                .from('todos')
                .update({
                    title: title,
                    category: category,
                    priority: priority,
                    due_date: dueDate
                })
                .eq('id', editingTodoId)
            
            if (error) {
                document.getElementById('edit-todo-message').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message
                document.getElementById('edit-todo-message').className = 'text-red-500 text-sm mb-4'
            } else {
                showNotification('TODOæ›´æ–°å®Œäº†', 'success', 'TODOãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ')
                closeEditTodoModal()
                loadTodos()
            }
        }

        // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–¢æ•°
        function filterByPeriod(period) {
            currentPeriod = period
            
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            document.querySelectorAll('.period-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.classList.add('bg-blue-100', 'border-blue-500')
                    btn.classList.remove('border-gray-300')
                } else {
                    btn.classList.remove('bg-blue-100', 'border-blue-500')
                    btn.classList.add('border-gray-300')
                }
            })
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
            filterTodos()
        }
        
        // æ¤œç´¢æ©Ÿèƒ½
        function filterTodos() {
            const searchText = document.getElementById('search-input').value.toLowerCase()
            const filterCategory = document.getElementById('filter-category').value
            const filterPriority = document.getElementById('filter-priority').value
            
            const filteredTodos = allTodos.filter(todo => {
                // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
                const matchesSearch = todo.title.toLowerCase().includes(searchText)
                
                // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿
                const matchesCategory = !filterCategory || todo.category === filterCategory
                
                // å„ªå…ˆåº¦ãƒ•ã‚£ãƒ«ã‚¿
                const matchesPriority = !filterPriority || todo.priority === parseInt(filterPriority)
                
                // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿
                let matchesPeriod = true
                if (currentPeriod !== 'all') {
                    const today = new Date()
                    today.setHours(0, 0, 0, 0)
                    const todoDate = new Date(todo.created_at)
                    
                    switch (currentPeriod) {
                        case 'today':
                            matchesPeriod = todoDate >= today
                            break
                        case 'week':
                            const weekAgo = new Date(today)
                            weekAgo.setDate(weekAgo.getDate() - 7)
                            matchesPeriod = todoDate >= weekAgo
                            break
                        case 'month':
                            const monthAgo = new Date(today)
                            monthAgo.setMonth(monthAgo.getMonth() - 1)
                            matchesPeriod = todoDate >= monthAgo
                            break
                    }
                }
                
                // ã™ã¹ã¦ã®æ¡ä»¶ã‚’æº€ãŸã™ã‚‚ã®ã ã‘ã‚’è¿”ã™
                return matchesSearch && matchesCategory && matchesPriority && matchesPeriod
            })
            
            displayTodos(filteredTodos)
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹å‡¦ç†
        function handleDragStart(event) {
            draggedTodoId = event.target.dataset.todoId
            event.target.style.opacity = '0.5'
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¨±å¯ï¼‰
        function handleDragOver(event) {
            event.preventDefault()
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function handleDrop(event) {
            event.preventDefault()
            const dropTargetId = event.target.closest('[data-todo-id]').dataset.todoId
            
            if (draggedTodoId && dropTargetId && draggedTodoId !== dropTargetId) {
                // é…åˆ—å†…ã§ä½ç½®ã‚’å…¥ã‚Œæ›¿ãˆ
                swapTodoPositions(parseInt(draggedTodoId), parseInt(dropTargetId))
            }
        }
        
        // TODOä½ç½®å…¥ã‚Œæ›¿ãˆé–¢æ•°
        function swapTodoPositions(draggedId, targetId) {
            const draggedIndex = allTodos.findIndex(todo => todo.id === draggedId)
            const targetIndex = allTodos.findIndex(todo => todo.id === targetId)
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
                // é…åˆ—å†…ã§ä½ç½®ã‚’äº¤æ›
                [allTodos[draggedIndex], allTodos[targetIndex]] = [allTodos[targetIndex], allTodos[draggedIndex]]
                // è¡¨ç¤ºã‚’æ›´æ–°
                displayTodos(allTodos)
            }
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†å‡¦ç†
        function handleDragEnd(event) {
            event.target.style.opacity = '1'
            draggedTodoId = null
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openLoginModal() {
            const modal = document.getElementById('login-modal')
            modal.classList.remove('hidden')
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeLoginModal() {
            const modal = document.getElementById('login-modal')
            modal.classList.add('hidden')
            // å…¥åŠ›å†…å®¹ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('modal-email').value = ''
            document.getElementById('modal-password').value = ''
            document.getElementById('modal-message').textContent = ''
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³
        async function modalSignIn() {
            const email = document.getElementById('modal-email').value
            const password = document.getElementById('modal-password').value
            
            if (!email || !password) {
                document.getElementById('modal-message').textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'
                document.getElementById('modal-message').className = 'text-red-500 text-sm mb-4'
                return
            }
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            })
            
            if (error) {
                document.getElementById('modal-message').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message
                document.getElementById('modal-message').className = 'text-red-500 text-sm mb-4'
            } else {
                closeLoginModal()
                showUserInfo(data.user)
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
        async function modalSignUp() {
            const email = document.getElementById('modal-email').value
            const password = document.getElementById('modal-password').value
            
            if (!email || !password) {
                document.getElementById('modal-message').textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'
                document.getElementById('modal-message').className = 'text-red-500 text-sm mb-4'
                return
            }
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password
            })
            
            if (error) {
                document.getElementById('modal-message').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message
                document.getElementById('modal-message').className = 'text-red-500 text-sm mb-4'
            } else {
                document.getElementById('modal-message').textContent = 'ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æˆåŠŸï¼ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„'
                document.getElementById('modal-message').className = 'text-green-500 text-sm mb-4'
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
        window.addEventListener('load', async () => {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯ã‹ã‚‰æ¥ãŸã‹ã©ã†ã‹ï¼‰
            const urlParams = new URLSearchParams(window.location.search)
            const accessToken = urlParams.get('access_token')
            const refreshToken = urlParams.get('refresh_token')
            const type = urlParams.get('type')
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®å ´åˆ
            if (type === 'recovery' && accessToken && refreshToken) {
                try {
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¨­å®š
                    const { error } = await supabase.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    })
                    
                    if (!error) {
                        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                        document.getElementById('reset-email-form').style.display = 'none'
                        document.getElementById('update-password-form').style.display = 'block'
                        openResetModal()
                    }
                } catch (err) {
                    console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šã‚¨ãƒ©ãƒ¼:', err)
                }
            } else {
                // é€šå¸¸ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
                const { data: { user } } = await supabase.auth.getUser()
                if (user) {
                    showUserInfo(user)
                }
            }
            
            // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.getElementById('search-input').addEventListener('input', filterTodos)
            document.getElementById('filter-category').addEventListener('change', filterTodos)
            document.getElementById('filter-priority').addEventListener('change', filterTodos)
            
            // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
            const emailInput = document.getElementById('email')
            const passwordInput = document.getElementById('password')
            
            const handleEnterKey = (event) => {
                if (event.key === 'Enter') {
                    signIn()
                }
            }
            
            emailInput.addEventListener('keypress', handleEnterKey)
            passwordInput.addEventListener('keypress', handleEnterKey)
            
            // ã‚¢ãƒã‚¿ãƒ¼é¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const avatarInput = document.getElementById('avatar-input')
            if (avatarInput) {
                avatarInput.addEventListener('change', handleAvatarSelection)
            }
            
            // é€šçŸ¥æ¨©é™ã‚’è¦æ±‚
            requestNotificationPermission()
            
            // åˆæœŸè¡¨ç¤ºã§å…¨æœŸé–“ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            filterByPeriod('all')
        })
        
        // ã‚¢ãƒã‚¿ãƒ¼ç”»åƒé¸æŠå‡¦ç†
        function handleAvatarSelection(event) {
            const file = event.target.files[0]
            if (!file) return
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ2MBï¼‰
            if (file.size > 2 * 1024 * 1024) {
                showProfileMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯2MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„', true)
                return
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
            if (!file.type.startsWith('image/')) {
                showProfileMessage('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', true)
                return
            }
            
            // FileReaderã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            const reader = new FileReader()
            reader.onload = function(e) {
                const previewImg = document.getElementById('profile-avatar-preview-img')
                const previewText = document.getElementById('profile-avatar-preview-text')
                
                previewImg.src = e.target.result
                previewImg.classList.remove('hidden')
                previewText.classList.add('hidden')
                
                // Base64ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆå®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯Supabase Storageã‚’ä½¿ç”¨ï¼‰
                window.selectedAvatarData = e.target.result
                
                showProfileMessage('ç”»åƒã‚’é¸æŠã—ã¾ã—ãŸï¼ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', false)
                showNotification('ã‚¢ãƒã‚¿ãƒ¼ç”»åƒãŒé¸æŠã•ã‚Œã¾ã—ãŸ', 'success')
            }
            reader.readAsDataURL(file)
        }
    </script>
    </div>
</body>
</html>