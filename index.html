<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase認証デモ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="max-w-4xl w-full space-y-8 p-8">
        <h1 class="text-3xl font-bold text-center text-gray-900">Supabase 認証テスト</h1>
    
    <div id="auth-form" class="bg-white p-8 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold text-gray-700 mb-6">ログイン/サインアップ</h2>
        <div id="message" class="text-sm mb-4"></div>
        <div class="space-y-4">
            <input type="email" id="email" placeholder="test@example.com" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="password" placeholder="test1234"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="space-y-2 mt-6">
        <button onclick="signUp()" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">サインアップ</button>
        <button onclick="signIn()" class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">ログイン</button>
        </div>
    </div>
    
    <div id="user-info" style="display:none;" class="bg-white p-8 rounded-lg shadow-md">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ダッシュボード</h2>
            
            <!-- 統計カード -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-400 to-blue-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="total-todos">0</div>
                    <div class="text-sm opacity-80">総TODO数</div>
                </div>
                <div class="bg-gradient-to-br from-green-400 to-green-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="completed-todos">0</div>
                    <div class="text-sm opacity-80">完了済み</div>
                </div>
                <div class="bg-gradient-to-br from-red-400 to-red-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="overdue-todos">0</div>
                    <div class="text-sm opacity-80">期限切れ</div>
                </div>
                <div class="bg-gradient-to-br from-purple-400 to-purple-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="high-priority-todos">0</div>
                    <div class="text-sm opacity-80">高優先度</div>
                </div>
            </div>
            
            <!-- グラフ表示エリア -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">カテゴリ別TODO</h4>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">優先度別TODO</h4>
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
            
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <p id="user-email" class="text-gray-700 font-medium"></p>
                <p id="user-created" class="text-gray-500 text-sm mt-1"></p>
                <p id="user-last-signin" class="text-gray-500 text-sm"></p>
            </div>
            <button onclick="signOut()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">ログアウト</button>
        </div>
        
        <!-- TODO入力フォーム -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">新しいTODO</h3>
            <div class="space-y-2">
                <input type="text" id="todo-input" placeholder="TODOを入力..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex space-x-2">
                    <select id="todo-category" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="general">一般</option>
                        <option value="work">仕事</option>
                        <option value="private">プライベート</option>
                        <option value="shopping">買い物</option>
                    </select>
                    <select id="todo-priority" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="3">高</option>
                        <option value="2" selected>中</option>
                        <option value="1">低</option>
                    </select>
                    <input type="date" id="todo-due-date" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="addTodo()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">追加</button>
                </div>
            </div>
        </div>
        
        <!-- 検索・フィルタセクション -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">検索・フィルタ</h3>
            <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                <input type="text" id="search-input" placeholder="TODOを検索..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex space-x-2">
                    <select id="filter-category" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">すべてのカテゴリ</option>
                        <option value="general">一般</option>
                        <option value="work">仕事</option>
                        <option value="private">プライベート</option>
                        <option value="shopping">買い物</option>
                    </select>
                    <select id="filter-priority" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">すべての優先度</option>
                        <option value="3">高</option>
                        <option value="2">中</option>
                        <option value="1">低</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- TODOリスト表示 -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">TODOリスト</h3>
            <div id="todo-list" class="space-y-2">
                <!-- TODOアイテムがここに表示される -->
            </div>
        </div>
    </div>

    <script>
        // Supabaseクライアントの初期化
        const supabaseUrl = 'https://quxokigryvzksexhbpbm.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1eG9raWdyeXZ6a3NleGhicGJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNTY5MTEsImV4cCI6MjA2ODczMjkxMX0.OEVIN34m7pnhrGO9tZ8wBxHNaNL7OCC0REpQOs6JjAQ'
        
        // TODOデータを保持する変数
        let allTodos = []
        
        // グラフインスタンスを保持する変数
        let categoryChart = null
        let priorityChart = null
        
        // ドラッグ中のTODO IDを保持
        let draggedTodoId = null
        
        // 完全にクリーンなSupabaseクライアント
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                detectSessionInUrl: false,
                persistSession: false,
                autoRefreshToken: false,
                flowType: 'implicit'
            },
            global: {
                headers: {
                    'x-custom-header': 'local-dev'
                }
            }
        })

        // サインアップ関数
        async function signUp() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            // メッセージをクリア
            hideMessage()
            
            console.log('現在のURL:', window.location.origin)
            console.log('サインアップリクエスト開始')
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password
            })
            
            console.log('サインアップレスポンス:', { data, error })
            
            if (error) {
                console.error('サインアップエラー詳細:', error)
                showMessage('エラー: ' + error.message, true)
            } else {
                showMessage('サインアップ成功！メールを確認してください', false)
                // 3秒後にメッセージを消す
                setTimeout(hideMessage, 3000)
            }
        }

        // メッセージ表示関数（エラーと成功両方に対応）
        function showMessage(message, isError = true) {
            const messageDiv = document.getElementById('message')
            messageDiv.textContent = message
            messageDiv.className = isError ? 'text-red-500 text-sm mb-4' : 'text-green-500 text-sm mb-4'
            messageDiv.style.display = 'block'
        }
        
        // メッセージ非表示関数
        function hideMessage() {
            const messageDiv = document.getElementById('message')
            messageDiv.textContent = ''
            messageDiv.style.display = 'none'
        }

        // ログイン関数
        async function signIn() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            // メッセージをクリア
            hideMessage()
            
            console.log('ログイン試行:', email)
            
            // ログインのみを実行
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            })
            
            console.log('ログイン結果:', { data, error })
            
            if (error) {
                console.error('詳細なエラー情報:', error)
                showMessage('エラー: ' + error.message, true)
            } else {
                showUserInfo(data.user)
            }
        }

        // ログアウト関数
        async function signOut() {
            await supabase.auth.signOut()
            hideUserInfo()
        }

        // ユーザー情報表示
        function showUserInfo(user) {
            document.getElementById('auth-form').style.display = 'none'
            document.getElementById('user-info').style.display = 'block'
            
            // プロフィール情報を表示
            document.getElementById('user-email').textContent = 'メール: ' + user.email
            document.getElementById('user-created').textContent = '登録日: ' + new Date(user.created_at).toLocaleDateString('ja-JP')
            document.getElementById('user-last-signin').textContent = '最終ログイン: ' + new Date(user.last_sign_in_at).toLocaleString('ja-JP')
            
            loadTodos()
        }

        // 統計情報更新関数
        function updateStats(todos) {
            const total = todos.length
            const completed = todos.filter(todo => todo.complete).length
            const overdue = todos.filter(todo => 
                todo.due_date && new Date(todo.due_date) < new Date() && !todo.complete
            ).length
            const highPriority = todos.filter(todo => todo.priority === 3).length
            
            document.getElementById('total-todos').textContent = total
            document.getElementById('completed-todos').textContent = completed
            document.getElementById('overdue-todos').textContent = overdue
            document.getElementById('high-priority-todos').textContent = highPriority
            
            // グラフも更新
            updateCharts(todos)
        }
        
        // グラフデータ集計関数
        function updateCharts(todos) {
            // カテゴリ別集計
            const categoryData = {
                general: todos.filter(t => t.category === 'general').length,
                work: todos.filter(t => t.category === 'work').length,
                private: todos.filter(t => t.category === 'private').length,
                shopping: todos.filter(t => t.category === 'shopping').length
            }
            
            // 優先度別集計
            const priorityData = {
                high: todos.filter(t => t.priority === 3).length,
                medium: todos.filter(t => t.priority === 2).length,
                low: todos.filter(t => t.priority === 1).length
            }
            
            // グラフを描画
            drawCharts(categoryData, priorityData)
        }
        
        // グラフ描画関数
        function drawCharts(categoryData, priorityData) {
            // 既存のグラフがあれば削除
            if (categoryChart) categoryChart.destroy()
            if (priorityChart) priorityChart.destroy()
            
            // カテゴリ別円グラフ
            const categoryCtx = document.getElementById('categoryChart').getContext('2d')
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['一般', '仕事', 'プライベート', '買い物'],
                    datasets: [{
                        data: [categoryData.general, categoryData.work, categoryData.private, categoryData.shopping],
                        backgroundColor: ['#9CA3AF', '#3B82F6', '#10B981', '#8B5CF6']
                    }]
                }
            })
            
            // 優先度別棒グラフ
            const priorityCtx = document.getElementById('priorityChart').getContext('2d')
            priorityChart = new Chart(priorityCtx, {
                type: 'bar',
                data: {
                    labels: ['高', '中', '低'],
                    datasets: [{
                        data: [priorityData.high, priorityData.medium, priorityData.low],
                        backgroundColor: ['#EF4444', '#F59E0B', '#10B981']
                    }]
                },
                options: {
                    plugins: { legend: { display: false } }
                }
            })
        }

        // ユーザー情報非表示
        function hideUserInfo() {
            document.getElementById('auth-form').style.display = 'block'
            document.getElementById('user-info').style.display = 'none'
        }

        // ユーザー状態確認関数
        async function checkUser() {
            const { data: { user }, error } = await supabase.auth.getUser()
            console.log('現在のユーザー:', user)
            console.log('エラー:', error)
            if (user) {
                alert(`ログイン中: ${user.email}\nメール確認: ${user.email_confirmed_at ? '確認済み' : '未確認'}`)
            } else {
                alert('ログインしていません')
            }
        }

        // TODO追加関数
        async function addTodo() {
            const todoInput = document.getElementById('todo-input')
            const categorySelect = document.getElementById('todo-category')
            const prioritySelect = document.getElementById('todo-priority')
            const dueDateInput = document.getElementById('todo-due-date')
            const title = todoInput.value.trim()
            const category = categorySelect.value
            const priority = parseInt(prioritySelect.value)
            const dueDate = dueDateInput.value || null
            
            if (!title) {
                alert('TODOを入力してください')
                return
            }
            
            const { data: { user } } = await supabase.auth.getUser()
            
            const { data, error } = await supabase
                .from('todos')
                .insert([
                    { user_id: user.id, title: title, category: category, priority: priority, due_date: dueDate, complete: false }
                ])
            
            if (error) {
                alert('エラー: ' + error.message)
            } else {
                todoInput.value = ''
                dueDateInput.value = ''
                loadTodos()
            }
        }

        // TODOリスト取得・表示関数
        async function loadTodos() {
            const { data: { user } } = await supabase.auth.getUser()
            
            const { data: todos, error } = await supabase
                .from('todos')
                .select('*')
                .eq('user_id', user.id)
                .order('priority', { ascending: false })
                .order('created_at', { ascending: false })
            
            if (error) {
                console.error('TODOリスト取得エラー:', error)
                return
            }
            
            // データを保存
            allTodos = todos
            
            // 表示を更新
            displayTodos(todos)
        }
        
        // TODOを表示する関数
        function displayTodos(todos) {
            const todoList = document.getElementById('todo-list')
            todoList.innerHTML = ''
            
            // 統計情報を更新
            updateStats(todos)
            
            todos.forEach(todo => {
                const categoryColors = {
                    'general': 'bg-gray-100 text-gray-700',
                    'work': 'bg-blue-100 text-blue-700',
                    'private': 'bg-green-100 text-green-700',
                    'shopping': 'bg-purple-100 text-purple-700'
                }
                const categoryNames = {
                    'general': '一般',
                    'work': '仕事',
                    'private': 'プライベート',
                    'shopping': '買い物'
                }
                const priorityColors = {
                    3: 'bg-red-100 text-red-700',
                    2: 'bg-yellow-100 text-yellow-700', 
                    1: 'bg-green-100 text-green-700'
                }
                const priorityNames = { 3: '高', 2: '中', 1: '低' }
                
                // 期限判定
                const isOverdue = todo.due_date && new Date(todo.due_date) < new Date() && !todo.complete
                const dueDateStr = todo.due_date ? new Date(todo.due_date).toLocaleDateString('ja-JP') : ''
                
                const todoItem = document.createElement('div')
                todoItem.className = `flex items-center p-3 rounded-md ${isOverdue ? 'bg-red-50 border-l-4 border-red-400' : 'bg-gray-50'} cursor-move`
                todoItem.draggable = true
                todoItem.dataset.todoId = todo.id
                
                // ドラッグイベントを追加
                todoItem.addEventListener('dragstart', handleDragStart)
                todoItem.addEventListener('dragover', handleDragOver)
                todoItem.addEventListener('drop', handleDrop)
                todoItem.addEventListener('dragend', handleDragEnd)
                todoItem.innerHTML = `
                    <span class="px-2 py-1 text-xs rounded-full ${priorityColors[todo.priority] || priorityColors[2]} mr-2">
                        ${priorityNames[todo.priority] || '中'}
                    </span>
                    <span class="px-2 py-1 text-xs rounded-full ${categoryColors[todo.category] || categoryColors.general} mr-2">
                        ${categoryNames[todo.category] || 'その他'}
                    </span>
                    ${dueDateStr ? `<span class="px-2 py-1 text-xs rounded ${isOverdue ? 'bg-red-200 text-red-800' : 'bg-blue-100 text-blue-700'} mr-2">📅${dueDateStr}</span>` : ''}
                    <span class="flex-1 ${todo.complete ? 'line-through text-gray-500' : 'text-gray-800'}">${todo.title}</span>
                    <button onclick="toggleTodo(${todo.id}, ${!todo.complete})" 
                            class="ml-2 px-3 py-1 text-sm rounded ${todo.complete ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white"
                            draggable="false">
                        ${todo.complete ? '未完了' : '完了'}
                    </button>
                    <button onclick="deleteTodo(${todo.id})" 
                            class="ml-2 px-3 py-1 text-sm rounded bg-red-500 hover:bg-red-600 text-white"
                            draggable="false">
                        削除
                    </button>
                `
                todoList.appendChild(todoItem)
            })
        }

        // TODO完了/未完了切り替え関数
        async function toggleTodo(id, completed) {
            const { data, error } = await supabase
                .from('todos')
                .update({ complete: completed })
                .eq('id', id)
            
            if (error) {
                alert('エラー: ' + error.message)
            } else {
                loadTodos()
            }
        }

        // TODO削除関数
        async function deleteTodo(id) {
            if (!confirm('このTODOを削除しますか？')) {
                return
            }
            
            const { data, error } = await supabase
                .from('todos')
                .delete()
                .eq('id', id)
            
            if (error) {
                alert('エラー: ' + error.message)
            } else {
                loadTodos()
            }
        }

        // 検索機能
        function filterTodos() {
            const searchText = document.getElementById('search-input').value.toLowerCase()
            const filterCategory = document.getElementById('filter-category').value
            const filterPriority = document.getElementById('filter-priority').value
            
            const filteredTodos = allTodos.filter(todo => {
                // テキスト検索
                const matchesSearch = todo.title.toLowerCase().includes(searchText)
                
                // カテゴリフィルタ
                const matchesCategory = !filterCategory || todo.category === filterCategory
                
                // 優先度フィルタ
                const matchesPriority = !filterPriority || todo.priority === parseInt(filterPriority)
                
                // すべての条件を満たすものだけを返す
                return matchesSearch && matchesCategory && matchesPriority
            })
            
            displayTodos(filteredTodos)
        }
        
        // ドラッグ開始処理
        function handleDragStart(event) {
            draggedTodoId = event.target.dataset.todoId
            event.target.style.opacity = '0.5'
        }
        
        // ドラッグオーバー処理（ドロップを許可）
        function handleDragOver(event) {
            event.preventDefault()
        }
        
        // ドロップ処理
        function handleDrop(event) {
            event.preventDefault()
            const dropTargetId = event.target.closest('[data-todo-id]').dataset.todoId
            
            if (draggedTodoId && dropTargetId && draggedTodoId !== dropTargetId) {
                // 配列内で位置を入れ替え
                swapTodoPositions(parseInt(draggedTodoId), parseInt(dropTargetId))
            }
        }
        
        // TODO位置入れ替え関数
        function swapTodoPositions(draggedId, targetId) {
            const draggedIndex = allTodos.findIndex(todo => todo.id === draggedId)
            const targetIndex = allTodos.findIndex(todo => todo.id === targetId)
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
                // 配列内で位置を交換
                [allTodos[draggedIndex], allTodos[targetIndex]] = [allTodos[targetIndex], allTodos[draggedIndex]]
                // 表示を更新
                displayTodos(allTodos)
            }
        }
        
        // ドラッグ終了処理
        function handleDragEnd(event) {
            event.target.style.opacity = '1'
            draggedTodoId = null
        }
        
        // ページ読み込み時にセッション確認
        window.addEventListener('load', async () => {
            const { data: { user } } = await supabase.auth.getUser()
            if (user) {
                showUserInfo(user)
            }
            
            // 検索ボックスにイベントリスナーを追加
            document.getElementById('search-input').addEventListener('input', filterTodos)
            document.getElementById('filter-category').addEventListener('change', filterTodos)
            document.getElementById('filter-priority').addEventListener('change', filterTodos)
        })
    </script>
    </div>
</body>
</html>