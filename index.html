<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabaseèªè¨¼ãƒ‡ãƒ¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="max-w-4xl w-full space-y-8 p-8">
        <h1 class="text-3xl font-bold text-center text-gray-900">Supabase èªè¨¼ãƒ†ã‚¹ãƒˆ</h1>
    
    <div id="auth-form" class="bg-white p-8 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold text-gray-700 mb-6">ãƒ­ã‚°ã‚¤ãƒ³/ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</h2>
        <div id="message" class="text-sm mb-4"></div>
        <div class="space-y-4">
            <input type="email" id="email" placeholder="test@example.com" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="password" placeholder="test1234"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="space-y-2 mt-6">
        <button onclick="signUp()" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</button>
        <button onclick="signIn()" class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
    </div>
    
    <div id="user-info" style="display:none;" class="bg-white p-8 rounded-lg shadow-md">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
            
            <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-400 to-blue-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="total-todos">0</div>
                    <div class="text-sm opacity-80">ç·TODOæ•°</div>
                </div>
                <div class="bg-gradient-to-br from-green-400 to-green-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="completed-todos">0</div>
                    <div class="text-sm opacity-80">å®Œäº†æ¸ˆã¿</div>
                </div>
                <div class="bg-gradient-to-br from-red-400 to-red-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="overdue-todos">0</div>
                    <div class="text-sm opacity-80">æœŸé™åˆ‡ã‚Œ</div>
                </div>
                <div class="bg-gradient-to-br from-purple-400 to-purple-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="high-priority-todos">0</div>
                    <div class="text-sm opacity-80">é«˜å„ªå…ˆåº¦</div>
                </div>
            </div>
            
            <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">ã‚«ãƒ†ã‚´ãƒªåˆ¥TODO</h4>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">å„ªå…ˆåº¦åˆ¥TODO</h4>
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
            
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <p id="user-email" class="text-gray-700 font-medium"></p>
                <p id="user-created" class="text-gray-500 text-sm mt-1"></p>
                <p id="user-last-signin" class="text-gray-500 text-sm"></p>
            </div>
            <button onclick="signOut()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        
        <!-- TODOå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">æ–°ã—ã„TODO</h3>
            <div class="space-y-2">
                <input type="text" id="todo-input" placeholder="TODOã‚’å…¥åŠ›..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex space-x-2">
                    <select id="todo-category" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="general">ä¸€èˆ¬</option>
                        <option value="work">ä»•äº‹</option>
                        <option value="private">ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</option>
                        <option value="shopping">è²·ã„ç‰©</option>
                    </select>
                    <select id="todo-priority" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="3">é«˜</option>
                        <option value="2" selected>ä¸­</option>
                        <option value="1">ä½</option>
                    </select>
                    <input type="date" id="todo-due-date" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="addTodo()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">è¿½åŠ </button>
                </div>
            </div>
        </div>
        
        <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿</h3>
            <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                <input type="text" id="search-input" placeholder="TODOã‚’æ¤œç´¢..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex space-x-2">
                    <select id="filter-category" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
                        <option value="general">ä¸€èˆ¬</option>
                        <option value="work">ä»•äº‹</option>
                        <option value="private">ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</option>
                        <option value="shopping">è²·ã„ç‰©</option>
                    </select>
                    <select id="filter-priority" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ã™ã¹ã¦ã®å„ªå…ˆåº¦</option>
                        <option value="3">é«˜</option>
                        <option value="2">ä¸­</option>
                        <option value="1">ä½</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- TODOãƒªã‚¹ãƒˆè¡¨ç¤º -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">TODOãƒªã‚¹ãƒˆ</h3>
            <div id="todo-list" class="space-y-2">
                <!-- TODOã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script>
        // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
        const supabaseUrl = 'https://quxokigryvzksexhbpbm.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1eG9raWdyeXZ6a3NleGhicGJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNTY5MTEsImV4cCI6MjA2ODczMjkxMX0.OEVIN34m7pnhrGO9tZ8wBxHNaNL7OCC0REpQOs6JjAQ'
        
        // TODOãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let allTodos = []
        
        // ã‚°ãƒ©ãƒ•ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let categoryChart = null
        let priorityChart = null
        
        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®TODO IDã‚’ä¿æŒ
        let draggedTodoId = null
        
        // å®Œå…¨ã«ã‚¯ãƒªãƒ¼ãƒ³ãªSupabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                detectSessionInUrl: false,
                persistSession: false,
                autoRefreshToken: false,
                flowType: 'implicit'
            },
            global: {
                headers: {
                    'x-custom-header': 'local-dev'
                }
            }
        })

        // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
        async function signUp() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            hideMessage()
            
            console.log('ç¾åœ¨ã®URL:', window.location.origin)
            console.log('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹')
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password
            })
            
            console.log('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', { data, error })
            
            if (error) {
                console.error('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼è©³ç´°:', error)
                showMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, true)
            } else {
                showMessage('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æˆåŠŸï¼ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„', false)
                // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
                setTimeout(hideMessage, 3000)
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°ï¼ˆã‚¨ãƒ©ãƒ¼ã¨æˆåŠŸä¸¡æ–¹ã«å¯¾å¿œï¼‰
        function showMessage(message, isError = true) {
            const messageDiv = document.getElementById('message')
            messageDiv.textContent = message
            messageDiv.className = isError ? 'text-red-500 text-sm mb-4' : 'text-green-500 text-sm mb-4'
            messageDiv.style.display = 'block'
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éè¡¨ç¤ºé–¢æ•°
        function hideMessage() {
            const messageDiv = document.getElementById('message')
            messageDiv.textContent = ''
            messageDiv.style.display = 'none'
        }

        // ãƒ­ã‚°ã‚¤ãƒ³é–¢æ•°
        async function signIn() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            hideMessage()
            
            console.log('ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ:', email)
            
            // ãƒ­ã‚°ã‚¤ãƒ³ã®ã¿ã‚’å®Ÿè¡Œ
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            })
            
            console.log('ãƒ­ã‚°ã‚¤ãƒ³çµæœ:', { data, error })
            
            if (error) {
                console.error('è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±:', error)
                showMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, true)
            } else {
                showUserInfo(data.user)
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–¢æ•°
        async function signOut() {
            await supabase.auth.signOut()
            hideUserInfo()
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
        function showUserInfo(user) {
            document.getElementById('auth-form').style.display = 'none'
            document.getElementById('user-info').style.display = 'block'
            
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('user-email').textContent = 'ãƒ¡ãƒ¼ãƒ«: ' + user.email
            document.getElementById('user-created').textContent = 'ç™»éŒ²æ—¥: ' + new Date(user.created_at).toLocaleDateString('ja-JP')
            document.getElementById('user-last-signin').textContent = 'æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³: ' + new Date(user.last_sign_in_at).toLocaleString('ja-JP')
            
            loadTodos()
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°é–¢æ•°
        function updateStats(todos) {
            const total = todos.length
            const completed = todos.filter(todo => todo.complete).length
            const overdue = todos.filter(todo => 
                todo.due_date && new Date(todo.due_date) < new Date() && !todo.complete
            ).length
            const highPriority = todos.filter(todo => todo.priority === 3).length
            
            document.getElementById('total-todos').textContent = total
            document.getElementById('completed-todos').textContent = completed
            document.getElementById('overdue-todos').textContent = overdue
            document.getElementById('high-priority-todos').textContent = highPriority
            
            // ã‚°ãƒ©ãƒ•ã‚‚æ›´æ–°
            updateCharts(todos)
        }
        
        // ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿é›†è¨ˆé–¢æ•°
        function updateCharts(todos) {
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥é›†è¨ˆ
            const categoryData = {
                general: todos.filter(t => t.category === 'general').length,
                work: todos.filter(t => t.category === 'work').length,
                private: todos.filter(t => t.category === 'private').length,
                shopping: todos.filter(t => t.category === 'shopping').length
            }
            
            // å„ªå…ˆåº¦åˆ¥é›†è¨ˆ
            const priorityData = {
                high: todos.filter(t => t.priority === 3).length,
                medium: todos.filter(t => t.priority === 2).length,
                low: todos.filter(t => t.priority === 1).length
            }
            
            // ã‚°ãƒ©ãƒ•ã‚’æç”»
            drawCharts(categoryData, priorityData)
        }
        
        // ã‚°ãƒ©ãƒ•æç”»é–¢æ•°
        function drawCharts(categoryData, priorityData) {
            // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ãŒã‚ã‚Œã°å‰Šé™¤
            if (categoryChart) categoryChart.destroy()
            if (priorityChart) priorityChart.destroy()
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥å††ã‚°ãƒ©ãƒ•
            const categoryCtx = document.getElementById('categoryChart').getContext('2d')
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ä¸€èˆ¬', 'ä»•äº‹', 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ', 'è²·ã„ç‰©'],
                    datasets: [{
                        data: [categoryData.general, categoryData.work, categoryData.private, categoryData.shopping],
                        backgroundColor: ['#9CA3AF', '#3B82F6', '#10B981', '#8B5CF6']
                    }]
                }
            })
            
            // å„ªå…ˆåº¦åˆ¥æ£’ã‚°ãƒ©ãƒ•
            const priorityCtx = document.getElementById('priorityChart').getContext('2d')
            priorityChart = new Chart(priorityCtx, {
                type: 'bar',
                data: {
                    labels: ['é«˜', 'ä¸­', 'ä½'],
                    datasets: [{
                        data: [priorityData.high, priorityData.medium, priorityData.low],
                        backgroundColor: ['#EF4444', '#F59E0B', '#10B981']
                    }]
                },
                options: {
                    plugins: { legend: { display: false } }
                }
            })
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±éè¡¨ç¤º
        function hideUserInfo() {
            document.getElementById('auth-form').style.display = 'block'
            document.getElementById('user-info').style.display = 'none'
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ç¢ºèªé–¢æ•°
        async function checkUser() {
            const { data: { user }, error } = await supabase.auth.getUser()
            console.log('ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user)
            console.log('ã‚¨ãƒ©ãƒ¼:', error)
            if (user) {
                alert(`ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.email}\nãƒ¡ãƒ¼ãƒ«ç¢ºèª: ${user.email_confirmed_at ? 'ç¢ºèªæ¸ˆã¿' : 'æœªç¢ºèª'}`)
            } else {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“')
            }
        }

        // TODOè¿½åŠ é–¢æ•°
        async function addTodo() {
            const todoInput = document.getElementById('todo-input')
            const categorySelect = document.getElementById('todo-category')
            const prioritySelect = document.getElementById('todo-priority')
            const dueDateInput = document.getElementById('todo-due-date')
            const title = todoInput.value.trim()
            const category = categorySelect.value
            const priority = parseInt(prioritySelect.value)
            const dueDate = dueDateInput.value || null
            
            if (!title) {
                alert('TODOã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
                return
            }
            
            const { data: { user } } = await supabase.auth.getUser()
            
            const { data, error } = await supabase
                .from('todos')
                .insert([
                    { user_id: user.id, title: title, category: category, priority: priority, due_date: dueDate, complete: false }
                ])
            
            if (error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message)
            } else {
                todoInput.value = ''
                dueDateInput.value = ''
                loadTodos()
            }
        }

        // TODOãƒªã‚¹ãƒˆå–å¾—ãƒ»è¡¨ç¤ºé–¢æ•°
        async function loadTodos() {
            const { data: { user } } = await supabase.auth.getUser()
            
            const { data: todos, error } = await supabase
                .from('todos')
                .select('*')
                .eq('user_id', user.id)
                .order('priority', { ascending: false })
                .order('created_at', { ascending: false })
            
            if (error) {
                console.error('TODOãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error)
                return
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            allTodos = todos
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            displayTodos(todos)
        }
        
        // TODOã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function displayTodos(todos) {
            const todoList = document.getElementById('todo-list')
            todoList.innerHTML = ''
            
            // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
            updateStats(todos)
            
            todos.forEach(todo => {
                const categoryColors = {
                    'general': 'bg-gray-100 text-gray-700',
                    'work': 'bg-blue-100 text-blue-700',
                    'private': 'bg-green-100 text-green-700',
                    'shopping': 'bg-purple-100 text-purple-700'
                }
                const categoryNames = {
                    'general': 'ä¸€èˆ¬',
                    'work': 'ä»•äº‹',
                    'private': 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ',
                    'shopping': 'è²·ã„ç‰©'
                }
                const priorityColors = {
                    3: 'bg-red-100 text-red-700',
                    2: 'bg-yellow-100 text-yellow-700', 
                    1: 'bg-green-100 text-green-700'
                }
                const priorityNames = { 3: 'é«˜', 2: 'ä¸­', 1: 'ä½' }
                
                // æœŸé™åˆ¤å®š
                const isOverdue = todo.due_date && new Date(todo.due_date) < new Date() && !todo.complete
                const dueDateStr = todo.due_date ? new Date(todo.due_date).toLocaleDateString('ja-JP') : ''
                
                const todoItem = document.createElement('div')
                todoItem.className = `flex items-center p-3 rounded-md ${isOverdue ? 'bg-red-50 border-l-4 border-red-400' : 'bg-gray-50'} cursor-move`
                todoItem.draggable = true
                todoItem.dataset.todoId = todo.id
                
                // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                todoItem.addEventListener('dragstart', handleDragStart)
                todoItem.addEventListener('dragover', handleDragOver)
                todoItem.addEventListener('drop', handleDrop)
                todoItem.addEventListener('dragend', handleDragEnd)
                todoItem.innerHTML = `
                    <span class="px-2 py-1 text-xs rounded-full ${priorityColors[todo.priority] || priorityColors[2]} mr-2">
                        ${priorityNames[todo.priority] || 'ä¸­'}
                    </span>
                    <span class="px-2 py-1 text-xs rounded-full ${categoryColors[todo.category] || categoryColors.general} mr-2">
                        ${categoryNames[todo.category] || 'ãã®ä»–'}
                    </span>
                    ${dueDateStr ? `<span class="px-2 py-1 text-xs rounded ${isOverdue ? 'bg-red-200 text-red-800' : 'bg-blue-100 text-blue-700'} mr-2">ğŸ“…${dueDateStr}</span>` : ''}
                    <span class="flex-1 ${todo.complete ? 'line-through text-gray-500' : 'text-gray-800'}">${todo.title}</span>
                    <button onclick="toggleTodo(${todo.id}, ${!todo.complete})" 
                            class="ml-2 px-3 py-1 text-sm rounded ${todo.complete ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white"
                            draggable="false">
                        ${todo.complete ? 'æœªå®Œäº†' : 'å®Œäº†'}
                    </button>
                    <button onclick="deleteTodo(${todo.id})" 
                            class="ml-2 px-3 py-1 text-sm rounded bg-red-500 hover:bg-red-600 text-white"
                            draggable="false">
                        å‰Šé™¤
                    </button>
                `
                todoList.appendChild(todoItem)
            })
        }

        // TODOå®Œäº†/æœªå®Œäº†åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        async function toggleTodo(id, completed) {
            const { data, error } = await supabase
                .from('todos')
                .update({ complete: completed })
                .eq('id', id)
            
            if (error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message)
            } else {
                loadTodos()
            }
        }

        // TODOå‰Šé™¤é–¢æ•°
        async function deleteTodo(id) {
            if (!confirm('ã“ã®TODOã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return
            }
            
            const { data, error } = await supabase
                .from('todos')
                .delete()
                .eq('id', id)
            
            if (error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message)
            } else {
                loadTodos()
            }
        }

        // æ¤œç´¢æ©Ÿèƒ½
        function filterTodos() {
            const searchText = document.getElementById('search-input').value.toLowerCase()
            const filterCategory = document.getElementById('filter-category').value
            const filterPriority = document.getElementById('filter-priority').value
            
            const filteredTodos = allTodos.filter(todo => {
                // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
                const matchesSearch = todo.title.toLowerCase().includes(searchText)
                
                // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿
                const matchesCategory = !filterCategory || todo.category === filterCategory
                
                // å„ªå…ˆåº¦ãƒ•ã‚£ãƒ«ã‚¿
                const matchesPriority = !filterPriority || todo.priority === parseInt(filterPriority)
                
                // ã™ã¹ã¦ã®æ¡ä»¶ã‚’æº€ãŸã™ã‚‚ã®ã ã‘ã‚’è¿”ã™
                return matchesSearch && matchesCategory && matchesPriority
            })
            
            displayTodos(filteredTodos)
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹å‡¦ç†
        function handleDragStart(event) {
            draggedTodoId = event.target.dataset.todoId
            event.target.style.opacity = '0.5'
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¨±å¯ï¼‰
        function handleDragOver(event) {
            event.preventDefault()
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function handleDrop(event) {
            event.preventDefault()
            const dropTargetId = event.target.closest('[data-todo-id]').dataset.todoId
            
            if (draggedTodoId && dropTargetId && draggedTodoId !== dropTargetId) {
                // é…åˆ—å†…ã§ä½ç½®ã‚’å…¥ã‚Œæ›¿ãˆ
                swapTodoPositions(parseInt(draggedTodoId), parseInt(dropTargetId))
            }
        }
        
        // TODOä½ç½®å…¥ã‚Œæ›¿ãˆé–¢æ•°
        function swapTodoPositions(draggedId, targetId) {
            const draggedIndex = allTodos.findIndex(todo => todo.id === draggedId)
            const targetIndex = allTodos.findIndex(todo => todo.id === targetId)
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
                // é…åˆ—å†…ã§ä½ç½®ã‚’äº¤æ›
                [allTodos[draggedIndex], allTodos[targetIndex]] = [allTodos[targetIndex], allTodos[draggedIndex]]
                // è¡¨ç¤ºã‚’æ›´æ–°
                displayTodos(allTodos)
            }
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†å‡¦ç†
        function handleDragEnd(event) {
            event.target.style.opacity = '1'
            draggedTodoId = null
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
        window.addEventListener('load', async () => {
            const { data: { user } } = await supabase.auth.getUser()
            if (user) {
                showUserInfo(user)
            }
            
            // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.getElementById('search-input').addEventListener('input', filterTodos)
            document.getElementById('filter-category').addEventListener('change', filterTodos)
            document.getElementById('filter-priority').addEventListener('change', filterTodos)
        })
    </script>
    </div>
</body>
</html>