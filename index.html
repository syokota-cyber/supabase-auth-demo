<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase認証デモ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="max-w-4xl w-full space-y-8 p-8">
        <h1 class="text-3xl font-bold text-center text-gray-900">Supabase 認証テスト</h1>
    
    <div id="auth-form" class="bg-white p-8 rounded-lg shadow-md text-center">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ようこそ！</h2>
        <p class="text-gray-600 mb-6">TODOアプリを使用するにはログインしてください</p>
        <button onclick="openLoginModal()" 
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg">
            ログイン / サインアップ
        </button>
    </div>
    
    <!-- ログインモーダル -->
    <div id="login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full relative">
            <button onclick="closeLoginModal()" 
                    class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">
                ×
            </button>
            <h3 class="text-xl font-semibold text-gray-700 mb-6">ログイン/サインアップ</h3>
            <div id="modal-message" class="text-sm mb-4"></div>
            <div class="space-y-4">
                <input type="email" id="modal-email" placeholder="test@example.com" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="modal-password" placeholder="test1234"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="space-y-2 mt-6">
                <button onclick="modalSignIn()" class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">ログイン</button>
                <button onclick="modalSignUp()" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">サインアップ</button>
            </div>
        </div>
    </div>

    <!-- パスワードリセットモーダル -->
    <div id="reset-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">パスワードリセット</h3>
            <div id="reset-message" class="text-sm mb-4"></div>
            
            <!-- メール送信フォーム -->
            <div id="reset-email-form">
                <p class="text-gray-600 mb-4">登録したメールアドレスに、パスワードリセット用のリンクを送信します。</p>
                <input type="email" id="reset-email" placeholder="メールアドレス" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <div class="flex space-x-2">
                    <button onclick="sendResetEmail()" 
                            id="send-reset-button"
                            class="flex-1 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                        送信
                    </button>
                    <button onclick="closeResetModal()" 
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded">
                        キャンセル
                    </button>
                </div>
            </div>
            
            <!-- パスワード更新フォーム（メールのリンクから開いた時用） -->
            <div id="update-password-form" style="display:none;">
                <p class="text-gray-600 mb-4">新しいパスワードを入力してください。</p>
                <input type="password" id="new-password" placeholder="新しいパスワード（6文字以上）" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <input type="password" id="confirm-password" placeholder="パスワード確認" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <div class="flex space-x-2">
                    <button onclick="updatePassword()" 
                            id="update-password-button"
                            class="flex-1 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                        パスワード更新
                    </button>
                    <button onclick="closeResetModal()" 
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TODO編集モーダル -->
    <div id="edit-todo-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">TODO編集</h3>
            <div id="edit-todo-message" class="text-sm mb-4"></div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">タイトル</label>
                    <input type="text" id="edit-todo-title" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">カテゴリ</label>
                    <select id="edit-todo-category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="general">一般</option>
                        <option value="work">仕事</option>
                        <option value="private">プライベート</option>
                        <option value="shopping">買い物</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">優先度</label>
                    <select id="edit-todo-priority" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="3">高</option>
                        <option value="2">中</option>
                        <option value="1">低</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">期限</label>
                    <input type="date" id="edit-todo-due-date" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="flex space-x-2 mt-6">
                <button onclick="updateTodo()" 
                        id="update-todo-button"
                        class="flex-1 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    更新
                </button>
                <button onclick="closeEditTodoModal()" 
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded">
                    キャンセル
                </button>
            </div>
        </div>
    </div>

    <!-- プロフィール編集モーダル -->
    <div id="profile-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">プロフィール編集</h3>
            <div id="profile-message" class="text-sm mb-4"></div>
            
            <div class="space-y-4">
                <!-- アバター選択 -->
                <div class="text-center">
                    <div class="w-20 h-20 bg-gray-300 rounded-full overflow-hidden flex items-center justify-center text-3xl mx-auto mb-2 border-2 border-gray-300">
                        <img id="profile-avatar-preview-img" src="" alt="Avatar" class="w-full h-full object-cover hidden">
                        <span id="profile-avatar-preview-text">👤</span>
                    </div>
                    <label class="text-sm text-blue-600 cursor-pointer hover:text-blue-800">
                        画像を選択
                        <input type="file" id="avatar-input" accept="image/*" class="hidden">
                    </label>
                    <p class="text-xs text-gray-500 mt-1">JPG, PNG, GIF (最大2MB)</p>
                </div>
                
                <!-- 表示名 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">表示名</label>
                    <input type="text" id="profile-display-name" placeholder="表示名を入力" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- 自己紹介 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">自己紹介</label>
                    <textarea id="profile-bio" placeholder="自己紹介を入力" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <!-- ウェブサイト -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ウェブサイト</label>
                    <input type="url" id="profile-website" placeholder="https://example.com" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="flex space-x-2 mt-6">
                <button onclick="saveProfile()" 
                        id="save-profile-button"
                        class="flex-1 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                    保存
                </button>
                <button onclick="closeProfileModal()" 
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded">
                    キャンセル
                </button>
            </div>
        </div>
    </div>
    
    <div id="user-info" style="display:none;" class="bg-white p-8 rounded-lg shadow-md">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ダッシュボード</h2>
            
            <!-- 統計カード -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-400 to-blue-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="total-todos">0</div>
                    <div class="text-sm opacity-80">総TODO数</div>
                </div>
                <div class="bg-gradient-to-br from-green-400 to-green-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="completed-todos">0</div>
                    <div class="text-sm opacity-80">完了済み</div>
                </div>
                <div class="bg-gradient-to-br from-red-400 to-red-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="overdue-todos">0</div>
                    <div class="text-sm opacity-80">期限切れ</div>
                </div>
                <div class="bg-gradient-to-br from-purple-400 to-purple-600 p-4 rounded-lg text-white transform hover:scale-105 transition-transform duration-200 shadow-lg">
                    <div class="text-2xl font-bold" id="high-priority-todos">0</div>
                    <div class="text-sm opacity-80">高優先度</div>
                </div>
            </div>
            
            <!-- グラフ表示エリア -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-semibold text-gray-700">カテゴリ別</h4>
                        <button onclick="switchCategoryChart()" 
                                class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded">
                            切替
                        </button>
                    </div>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-semibold text-gray-700">優先度別</h4>
                        <button onclick="switchPriorityChart()" 
                                class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded">
                            切替
                        </button>
                    </div>
                    <canvas id="priorityChart"></canvas>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-semibold text-gray-700">進捗状況</h4>
                        <button onclick="switchStatusChart()" 
                                class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded">
                            切替
                        </button>
                    </div>
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            
            <div class="bg-blue-50 p-6 rounded-lg mb-4">
                <div class="flex items-center space-x-4 mb-4">
                    <div class="w-16 h-16 bg-gray-300 rounded-full overflow-hidden flex items-center justify-center text-2xl border-2 border-gray-300">
                        <img id="user-avatar-img" src="" alt="Avatar" class="w-full h-full object-cover hidden">
                        <span id="user-avatar-text">👤</span>
                    </div>
                    <div class="flex-1">
                        <h3 id="user-display-name" class="text-xl font-semibold text-gray-800">ユーザー名</h3>
                        <p id="user-email" class="text-gray-600"></p>
                    </div>
                    <button onclick="openProfileModal()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                        プロフィール編集
                    </button>
                </div>
                <div class="border-t pt-4 space-y-2">
                    <p id="user-bio" class="text-gray-700 text-sm italic">自己紹介がありません</p>
                    <div class="grid grid-cols-2 gap-4 text-xs text-gray-500">
                        <div>
                            <strong>登録日:</strong>
                            <span id="user-created"></span>
                        </div>
                        <div>
                            <strong>最終ログイン:</strong>
                            <span id="user-last-signin"></span>
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="signOut()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">ログアウト</button>
        </div>
        
        <!-- TODO入力フォーム -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">新しいTODO</h3>
            <div class="space-y-2">
                <input type="text" id="todo-input" placeholder="TODOを入力..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex space-x-2">
                    <select id="todo-category" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="general">一般</option>
                        <option value="work">仕事</option>
                        <option value="private">プライベート</option>
                        <option value="shopping">買い物</option>
                    </select>
                    <select id="todo-priority" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="3">高</option>
                        <option value="2" selected>中</option>
                        <option value="1">低</option>
                    </select>
                    <input type="date" id="todo-due-date" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="addTodo()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">追加</button>
                </div>
            </div>
        </div>
        
        <!-- 検索・フィルタセクション -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">検索・フィルタ</h3>
            <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                <!-- 期間フィルターボタン -->
                <div class="flex space-x-2 mb-3">
                    <button onclick="filterByPeriod('all')" 
                            class="period-btn flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-blue-50 focus:bg-blue-100 focus:border-blue-500"
                            data-period="all">
                        全期間
                    </button>
                    <button onclick="filterByPeriod('today')" 
                            class="period-btn flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-blue-50 focus:bg-blue-100 focus:border-blue-500"
                            data-period="today">
                        今日
                    </button>
                    <button onclick="filterByPeriod('week')" 
                            class="period-btn flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-blue-50 focus:bg-blue-100 focus:border-blue-500"
                            data-period="week">
                        今週
                    </button>
                    <button onclick="filterByPeriod('month')" 
                            class="period-btn flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-blue-50 focus:bg-blue-100 focus:border-blue-500"
                            data-period="month">
                        今月
                    </button>
                </div>
                
                <input type="text" id="search-input" placeholder="TODOを検索..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex space-x-2">
                    <select id="filter-category" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">すべてのカテゴリ</option>
                        <option value="general">一般</option>
                        <option value="work">仕事</option>
                        <option value="private">プライベート</option>
                        <option value="shopping">買い物</option>
                    </select>
                    <select id="filter-priority" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">すべての優先度</option>
                        <option value="3">高</option>
                        <option value="2">中</option>
                        <option value="1">低</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- TODOリスト表示 -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">TODOリスト</h3>
            <div id="todo-list" class="space-y-2">
                <!-- TODOアイテムがここに表示される -->
            </div>
        </div>
    </div>

    <script>
        // Supabaseクライアントの初期化
        const supabaseUrl = 'https://quxokigryvzksexhbpbm.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1eG9raWdyeXZ6a3NleGhicGJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNTY5MTEsImV4cCI6MjA2ODczMjkxMX0.OEVIN34m7pnhrGO9tZ8wBxHNaNL7OCC0REpQOs6JjAQ'
        
        // TODOデータを保持する変数
        let allTodos = []
        
        // グラフインスタンスを保持する変数
        let categoryChart = null
        let priorityChart = null
        let statusChart = null
        
        // グラフタイプを管理する変数
        let categoryChartType = 'doughnut'  // 初期は円グラフ
        let priorityChartType = 'bar'       // 初期は棒グラフ
        let statusChartType = 'doughnut'    // 初期は円グラフ
        
        // ドラッグ中のTODO IDを保持
        let draggedTodoId = null
        
        // 編集中のTODO IDを保持
        let editingTodoId = null
        
        // 現在の期間フィルター
        let currentPeriod = 'all'
        
        // 完全にクリーンなSupabaseクライアント
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                detectSessionInUrl: false,
                persistSession: false,
                autoRefreshToken: false,
                flowType: 'implicit'
            },
            global: {
                headers: {
                    'x-custom-header': 'local-dev'
                }
            }
        })

        // サインアップ関数
        async function signUp() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            // 入力チェック
            if (!email || !password) {
                showMessage('メールアドレスとパスワードを入力してください', true)
                return
            }
            
            // メールアドレスの形式チェック
            if (!isValidEmail(email)) {
                showMessage('正しいメールアドレスの形式で入力してください', true)
                return
            }
            
            // パスワードの長さチェック
            if (password.length < 6) {
                showMessage('パスワードは6文字以上で入力してください', true)
                return
            }
            
            // メッセージをクリア
            hideMessage()
            
            // ローディング開始
            setLoading(true)
            
            try {
                console.log('現在のURL:', window.location.origin)
                console.log('サインアップリクエスト開始')
                
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password
                })
                
                console.log('サインアップレスポンス:', { data, error })
                
                if (error) {
                    console.error('サインアップエラー詳細:', error)
                    showMessage('エラー: ' + error.message, true)
                } else {
                    showMessage('サインアップ成功！メールを確認してください', false)
                    // 3秒後にメッセージを消す
                    setTimeout(hideMessage, 3000)
                }
            } finally {
                // ローディング終了
                setLoading(false)
            }
        }

        // メッセージ表示関数（エラーと成功両方に対応）
        function showMessage(message, isError = true) {
            const messageDiv = document.getElementById('message')
            messageDiv.textContent = message
            messageDiv.className = isError ? 'text-red-500 text-sm mb-4' : 'text-green-500 text-sm mb-4'
            messageDiv.style.display = 'block'
        }
        
        // メッセージ非表示関数
        function hideMessage() {
            const messageDiv = document.getElementById('message')
            messageDiv.textContent = ''
            messageDiv.style.display = 'none'
        }
        
        // ローディング状態の管理
        function setLoading(isLoading) {
            const signupButton = document.getElementById('signup-button')
            const signinButton = document.getElementById('signin-button')
            
            if (isLoading) {
                signupButton.disabled = true
                signinButton.disabled = true
                signupButton.textContent = '処理中...'
                signinButton.textContent = '処理中...'
            } else {
                signupButton.disabled = false
                signinButton.disabled = false
                signupButton.textContent = 'サインアップ'
                signinButton.textContent = 'ログイン'
            }
        }
        
        // メールアドレスの形式チェック
        function isValidEmail(email) {
            // 基本的なメール形式のパターン
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
            return emailPattern.test(email)
        }
        
        // パスワードの表示/非表示切り替え
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password')
            const toggleIcon = document.getElementById('password-toggle-icon')
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text'
                toggleIcon.textContent = '🙈'
            } else {
                passwordInput.type = 'password'
                toggleIcon.textContent = '👁️'
            }
        }
        
        // リセットモーダルを開く
        function openResetModal() {
            const modal = document.getElementById('reset-modal')
            modal.classList.remove('hidden')
            document.getElementById('reset-email').value = ''
            hideResetMessage()
        }
        
        // リセットモーダルを閉じる
        function closeResetModal() {
            const modal = document.getElementById('reset-modal')
            modal.classList.add('hidden')
            hideResetMessage()
        }
        
        // リセットメッセージ表示
        function showResetMessage(message, isError = true) {
            const messageDiv = document.getElementById('reset-message')
            messageDiv.textContent = message
            messageDiv.className = isError ? 'text-red-500 text-sm mb-4' : 'text-green-500 text-sm mb-4'
            messageDiv.style.display = 'block'
        }
        
        // リセットメッセージ非表示
        function hideResetMessage() {
            const messageDiv = document.getElementById('reset-message')
            messageDiv.textContent = ''
            messageDiv.style.display = 'none'
        }
        
        // パスワードリセットメール送信
        async function sendResetEmail() {
            const email = document.getElementById('reset-email').value
            
            // 入力チェック
            if (!email) {
                showResetMessage('メールアドレスを入力してください', true)
                return
            }
            
            // メールアドレスの形式チェック
            if (!isValidEmail(email)) {
                showResetMessage('正しいメールアドレスの形式で入力してください', true)
                return
            }
            
            // ローディング開始
            const sendButton = document.getElementById('send-reset-button')
            sendButton.disabled = true
            sendButton.textContent = '送信中...'
            
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/index.html'
                })
                
                if (error) {
                    console.error('リセットメール送信エラー:', error)
                    showResetMessage('エラー: ' + error.message, true)
                } else {
                    showResetMessage('パスワードリセットメールを送信しました。メールをご確認ください。', false)
                    // 5秒後にモーダルを閉じる
                    setTimeout(() => {
                        closeResetModal()
                    }, 5000)
                }
            } finally {
                // ローディング終了
                sendButton.disabled = false
                sendButton.textContent = '送信'
            }
        }
        
        // パスワード更新機能
        async function updatePassword() {
            const newPassword = document.getElementById('new-password').value
            const confirmPassword = document.getElementById('confirm-password').value
            
            // 入力チェック
            if (!newPassword || !confirmPassword) {
                showResetMessage('パスワードを入力してください', true)
                return
            }
            
            // パスワードの長さチェック
            if (newPassword.length < 6) {
                showResetMessage('パスワードは6文字以上で入力してください', true)
                return
            }
            
            // パスワード確認チェック
            if (newPassword !== confirmPassword) {
                showResetMessage('パスワードが一致しません', true)
                return
            }
            
            // ローディング開始
            const updateButton = document.getElementById('update-password-button')
            updateButton.disabled = true
            updateButton.textContent = '更新中...'
            
            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                })
                
                if (error) {
                    console.error('パスワード更新エラー:', error)
                    showResetMessage('エラー: ' + error.message, true)
                } else {
                    showResetMessage('パスワードが正常に更新されました！', false)
                    // 3秒後にモーダルを閉じてメインページを表示
                    setTimeout(() => {
                        closeResetModal()
                        location.reload() // ページをリロードしてログイン状態を反映
                    }, 3000)
                }
            } finally {
                // ローディング終了
                updateButton.disabled = false
                updateButton.textContent = 'パスワード更新'
            }
        }
        
        // プロフィールモーダル関連の関数
        function openProfileModal() {
            const modal = document.getElementById('profile-modal')
            modal.classList.remove('hidden')
            loadCurrentProfile()
            hideProfileMessage()
        }
        
        function closeProfileModal() {
            const modal = document.getElementById('profile-modal')
            modal.classList.add('hidden')
            hideProfileMessage()
        }
        
        // プロフィールメッセージ表示
        function showProfileMessage(message, isError = true) {
            const messageDiv = document.getElementById('profile-message')
            messageDiv.textContent = message
            messageDiv.className = isError ? 'text-red-500 text-sm mb-4' : 'text-green-500 text-sm mb-4'
            messageDiv.style.display = 'block'
        }
        
        // プロフィールメッセージ非表示
        function hideProfileMessage() {
            const messageDiv = document.getElementById('profile-message')
            messageDiv.textContent = ''
            messageDiv.style.display = 'none'
        }
        
        // 現在のプロフィール情報を読み込み
        async function loadCurrentProfile() {
            try {
                const { data: { user } } = await supabase.auth.getUser()
                if (user && user.user_metadata) {
                    const metadata = user.user_metadata
                    
                    // フォームに現在の値を設定
                    document.getElementById('profile-display-name').value = metadata.display_name || ''
                    document.getElementById('profile-bio').value = metadata.bio || ''
                    document.getElementById('profile-website').value = metadata.website || ''
                    
                    // アバタープレビューを更新
                    const previewImg = document.getElementById('profile-avatar-preview-img')
                    const previewText = document.getElementById('profile-avatar-preview-text')
                    
                    if (metadata.avatar_type === 'image' && metadata.avatar) {
                        previewImg.src = metadata.avatar
                        previewImg.classList.remove('hidden')
                        previewText.classList.add('hidden')
                        window.selectedAvatarData = metadata.avatar
                    } else {
                        previewText.textContent = metadata.avatar || '👤'
                        previewImg.classList.add('hidden')
                        previewText.classList.remove('hidden')
                        window.selectedAvatarData = null
                    }
                }
            } catch (error) {
                console.error('プロフィール読み込みエラー:', error)
            }
        }
        
        // プロフィール保存機能
        async function saveProfile() {
            const displayName = document.getElementById('profile-display-name').value.trim()
            const bio = document.getElementById('profile-bio').value.trim()
            const website = document.getElementById('profile-website').value.trim()
            
            // 表示名の入力チェック
            if (!displayName) {
                showProfileMessage('表示名を入力してください', true)
                return
            }
            
            // ウェブサイトURLの形式チェック
            if (website && !isValidUrl(website)) {
                showProfileMessage('正しいURL形式で入力してください', true)
                return
            }
            
            // ローディング開始
            const saveButton = document.getElementById('save-profile-button')
            saveButton.disabled = true
            saveButton.textContent = '保存中...'
            
            try {
                // アバターデータを取得（画像または絵文字）
                const avatarData = window.selectedAvatarData || document.getElementById('profile-avatar-preview-text').textContent
                
                const { error } = await supabase.auth.updateUser({
                    data: {
                        display_name: displayName,
                        bio: bio,
                        website: website,
                        avatar: avatarData,
                        avatar_type: window.selectedAvatarData ? 'image' : 'emoji'
                    }
                })
                
                if (error) {
                    console.error('プロフィール更新エラー:', error)
                    showProfileMessage('エラー: ' + error.message, true)
                } else {
                    showProfileMessage('プロフィールが正常に更新されました！', false)
                    showNotification('プロフィール更新完了', 'success', '変更が保存されました')
                    
                    // メイン画面のプロフィール表示を更新
                    updateProfileDisplay()
                    
                    // 2秒後にモーダルを閉じる
                    setTimeout(() => {
                        closeProfileModal()
                    }, 2000)
                }
            } finally {
                // ローディング終了
                saveButton.disabled = false
                saveButton.textContent = '保存'
            }
        }
        
        // URL形式チェック
        function isValidUrl(string) {
            try {
                new URL(string)
                return true
            } catch (_) {
                return false
            }
        }
        
        // ブラウザ通知機能
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission()
                return permission === 'granted'
            }
            return false
        }
        
        // 通知を表示
        function showNotification(title, type = 'info', body = '') {
            // アプリ内通知
            showInAppNotification(title, type, body)
            
            // ブラウザ通知
            if (Notification.permission === 'granted') {
                const options = {
                    body: body,
                    icon: '👤', // 簡易アイコン
                    badge: '📱',
                    tag: 'todo-app-notification'
                }
                
                const iconMap = {
                    'success': '✅',
                    'error': '❌',
                    'warning': '⚠️',
                    'info': 'ℹ️'
                }
                
                options.icon = iconMap[type] || '📱'
                
                const notification = new Notification(title, options)
                
                // 5秒後に自動で閉じる
                setTimeout(() => {
                    notification.close()
                }, 5000)
            }
        }
        
        // アプリ内通知（画面内のトースト通知）
        function showInAppNotification(title, type = 'info', body = '') {
            // 通知コンテナが存在しない場合は作成
            let container = document.getElementById('notification-container')
            if (!container) {
                container = document.createElement('div')
                container.id = 'notification-container'
                container.className = 'fixed top-4 right-4 z-50 space-y-2'
                document.body.appendChild(container)
            }
            
            // 通知要素を作成
            const notification = document.createElement('div')
            notification.className = `p-4 rounded-lg shadow-lg max-w-sm ${getNotificationStyle(type)} transform transition-all duration-300 ease-in-out opacity-0 translate-x-full`
            
            const iconMap = {
                'success': '✅',
                'error': '❌',
                'warning': '⚠️',
                'info': 'ℹ️'
            }
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <span class="text-lg mr-3">${iconMap[type] || 'ℹ️'}</span>
                    <div class="flex-1">
                        <div class="font-medium">${title}</div>
                        ${body ? `<div class="text-sm mt-1">${body}</div>` : ''}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-400 hover:text-gray-600">×</button>
                </div>
            `
            
            container.appendChild(notification)
            
            // アニメーション表示
            setTimeout(() => {
                notification.classList.remove('opacity-0', 'translate-x-full')
            }, 100)
            
            // 5秒後に自動削除
            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-x-full')
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove()
                    }
                }, 300)
            }, 5000)
        }
        
        // 通知スタイルを取得
        function getNotificationStyle(type) {
            const styles = {
                'success': 'bg-green-100 border-green-500 text-green-700',
                'error': 'bg-red-100 border-red-500 text-red-700',
                'warning': 'bg-yellow-100 border-yellow-500 text-yellow-700',
                'info': 'bg-blue-100 border-blue-500 text-blue-700'
            }
            return styles[type] || styles.info
        }

        // ログイン関数
        async function signIn() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            // 入力チェック
            if (!email || !password) {
                showMessage('メールアドレスとパスワードを入力してください', true)
                return
            }
            
            // メールアドレスの形式チェック
            if (!isValidEmail(email)) {
                showMessage('正しいメールアドレスの形式で入力してください', true)
                return
            }
            
            // メッセージをクリア
            hideMessage()
            
            // ローディング開始
            setLoading(true)
            
            try {
                console.log('ログイン試行:', email)
                
                // ログインのみを実行
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                })
                
                console.log('ログイン結果:', { data, error })
                
                if (error) {
                    console.error('詳細なエラー情報:', error)
                    showMessage('エラー: ' + error.message, true)
                } else {
                    showMessage('ログインに成功しました！', false)
                    showNotification('ログイン成功', 'success', 'ようこそ！')
                    setTimeout(() => {
                        showUserInfo(data.user)
                    }, 1000)
                }
            } finally {
                // ローディング終了
                setLoading(false)
            }
        }

        // ログアウト関数
        async function signOut() {
            await supabase.auth.signOut()
            hideUserInfo()
        }

        // ユーザー情報表示
        function showUserInfo(user) {
            document.getElementById('auth-form').style.display = 'none'
            document.getElementById('user-info').style.display = 'block'
            
            // プロフィール情報を表示
            updateProfileDisplay(user)
            
            loadTodos()
        }
        
        // プロフィール表示を更新
        async function updateProfileDisplay(user = null) {
            if (!user) {
                const { data: { user: currentUser } } = await supabase.auth.getUser()
                user = currentUser
            }
            
            if (user) {
                const metadata = user.user_metadata || {}
                
                // 基本情報
                document.getElementById('user-email').textContent = user.email
                document.getElementById('user-created').textContent = new Date(user.created_at).toLocaleDateString('ja-JP')
                document.getElementById('user-last-signin').textContent = new Date(user.last_sign_in_at).toLocaleString('ja-JP')
                
                // カスタム情報
                document.getElementById('user-display-name').textContent = metadata.display_name || 'ユーザー名'
                
                // アバター表示（画像または絵文字）
                const avatarImg = document.getElementById('user-avatar-img')
                const avatarText = document.getElementById('user-avatar-text')
                
                if (metadata.avatar_type === 'image' && metadata.avatar) {
                    avatarImg.src = metadata.avatar
                    avatarImg.classList.remove('hidden')
                    avatarText.classList.add('hidden')
                } else {
                    avatarText.textContent = metadata.avatar || '👤'
                    avatarImg.classList.add('hidden')
                    avatarText.classList.remove('hidden')
                }
                
                const bioElement = document.getElementById('user-bio')
                if (metadata.bio) {
                    bioElement.textContent = metadata.bio
                    bioElement.classList.remove('italic')
                } else {
                    bioElement.textContent = '自己紹介がありません'
                    bioElement.classList.add('italic')
                }
                
                // ウェブサイトリンクがある場合は表示
                if (metadata.website) {
                    bioElement.innerHTML += `<br><a href="${metadata.website}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs">🌐 ${metadata.website}</a>`
                }
            }
        }

        // 統計情報更新関数
        function updateStats(todos) {
            const total = todos.length
            const completed = todos.filter(todo => todo.complete).length
            const overdue = todos.filter(todo => 
                todo.due_date && new Date(todo.due_date) < new Date() && !todo.complete
            ).length
            const highPriority = todos.filter(todo => todo.priority === 3).length
            
            document.getElementById('total-todos').textContent = total
            document.getElementById('completed-todos').textContent = completed
            document.getElementById('overdue-todos').textContent = overdue
            document.getElementById('high-priority-todos').textContent = highPriority
            
            // グラフも更新
            updateCharts(todos)
        }
        
        // グラフデータ集計関数
        function updateCharts(todos) {
            // カテゴリ別集計
            const categoryData = {
                general: todos.filter(t => t.category === 'general').length,
                work: todos.filter(t => t.category === 'work').length,
                private: todos.filter(t => t.category === 'private').length,
                shopping: todos.filter(t => t.category === 'shopping').length
            }
            
            // 優先度別集計
            const priorityData = {
                high: todos.filter(t => t.priority === 3).length,
                medium: todos.filter(t => t.priority === 2).length,
                low: todos.filter(t => t.priority === 1).length
            }
            
            // 進捗状況別集計
            const statusData = {
                completed: todos.filter(t => t.complete).length,
                incomplete: todos.filter(t => !t.complete).length
            }
            
            // グラフを描画
            drawCharts(categoryData, priorityData, statusData)
        }
        
        // グラフ描画関数
        function drawCharts(categoryData, priorityData, statusData) {
            // 既存のグラフがあれば削除
            if (categoryChart) categoryChart.destroy()
            if (priorityChart) priorityChart.destroy()
            if (statusChart) statusChart.destroy()
            
            // カテゴリ別グラフ
            const categoryCtx = document.getElementById('categoryChart').getContext('2d')
            categoryChart = new Chart(categoryCtx, {
                type: categoryChartType,
                data: {
                    labels: ['一般', '仕事', 'プライベート', '買い物'],
                    datasets: [{
                        data: [categoryData.general, categoryData.work, categoryData.private, categoryData.shopping],
                        backgroundColor: ['#9CA3AF', '#3B82F6', '#10B981', '#8B5CF6']
                    }]
                },
                options: {
                    plugins: { 
                        legend: { display: categoryChartType !== 'bar' }
                    }
                }
            })
            
            // 優先度別グラフ
            const priorityCtx = document.getElementById('priorityChart').getContext('2d')
            priorityChart = new Chart(priorityCtx, {
                type: priorityChartType,
                data: {
                    labels: ['高', '中', '低'],
                    datasets: [{
                        data: [priorityData.high, priorityData.medium, priorityData.low],
                        backgroundColor: ['#EF4444', '#F59E0B', '#10B981']
                    }]
                },
                options: {
                    plugins: { 
                        legend: { display: priorityChartType !== 'bar' } 
                    }
                }
            })
            
            // 進捗状況グラフ
            const statusCtx = document.getElementById('statusChart').getContext('2d')
            statusChart = new Chart(statusCtx, {
                type: statusChartType,
                data: {
                    labels: ['完了', '未完了'],
                    datasets: [{
                        data: [statusData.completed, statusData.incomplete],
                        backgroundColor: ['#10B981', '#EF4444']
                    }]
                },
                options: {
                    plugins: { 
                        legend: { display: statusChartType !== 'bar' }
                    }
                }
            })
        }
        
        // カテゴリグラフ切り替え関数
        function switchCategoryChart() {
            const types = ['doughnut', 'bar', 'pie', 'line']
            const currentIndex = types.indexOf(categoryChartType)
            categoryChartType = types[(currentIndex + 1) % types.length]
            
            // 現在のデータで再描画
            updateCharts(allTodos)
        }
        
        // 優先度グラフ切り替え関数
        function switchPriorityChart() {
            const types = ['bar', 'doughnut', 'pie', 'line']
            const currentIndex = types.indexOf(priorityChartType)
            priorityChartType = types[(currentIndex + 1) % types.length]
            
            // 現在のデータで再描画
            updateCharts(allTodos)
        }
        
        // 進捗状況グラフ切り替え関数
        function switchStatusChart() {
            const types = ['doughnut', 'bar', 'pie', 'line']
            const currentIndex = types.indexOf(statusChartType)
            statusChartType = types[(currentIndex + 1) % types.length]
            
            // 現在のデータで再描画
            updateCharts(allTodos)
        }

        // ユーザー情報非表示
        function hideUserInfo() {
            document.getElementById('auth-form').style.display = 'block'
            document.getElementById('user-info').style.display = 'none'
        }

        // ユーザー状態確認関数
        async function checkUser() {
            const { data: { user }, error } = await supabase.auth.getUser()
            console.log('現在のユーザー:', user)
            console.log('エラー:', error)
            if (user) {
                alert(`ログイン中: ${user.email}\nメール確認: ${user.email_confirmed_at ? '確認済み' : '未確認'}`)
            } else {
                alert('ログインしていません')
            }
        }

        // TODO追加関数
        async function addTodo() {
            const todoInput = document.getElementById('todo-input')
            const categorySelect = document.getElementById('todo-category')
            const prioritySelect = document.getElementById('todo-priority')
            const dueDateInput = document.getElementById('todo-due-date')
            const title = todoInput.value.trim()
            const category = categorySelect.value
            const priority = parseInt(prioritySelect.value)
            const dueDate = dueDateInput.value || null
            
            if (!title) {
                alert('TODOを入力してください')
                return
            }
            
            const { data: { user } } = await supabase.auth.getUser()
            
            const { data, error } = await supabase
                .from('todos')
                .insert([
                    { user_id: user.id, title: title, category: category, priority: priority, due_date: dueDate, complete: false }
                ])
            
            if (error) {
                alert('エラー: ' + error.message)
                showNotification('TODO追加エラー', 'error', error.message)
            } else {
                todoInput.value = ''
                dueDateInput.value = ''
                showNotification('TODO追加完了', 'success', 'TODOが追加されました')
                loadTodos()
            }
        }

        // TODOリスト取得・表示関数
        async function loadTodos() {
            const { data: { user } } = await supabase.auth.getUser()
            
            const { data: todos, error } = await supabase
                .from('todos')
                .select('*')
                .eq('user_id', user.id)
                .order('priority', { ascending: false })
                .order('created_at', { ascending: false })
            
            if (error) {
                console.error('TODOリスト取得エラー:', error)
                return
            }
            
            // データを保存
            allTodos = todos
            
            // 表示を更新
            displayTodos(todos)
        }
        
        // TODOを表示する関数
        function displayTodos(todos) {
            const todoList = document.getElementById('todo-list')
            todoList.innerHTML = ''
            
            // 統計情報を更新
            updateStats(todos)
            
            todos.forEach(todo => {
                const categoryColors = {
                    'general': 'bg-gray-100 text-gray-700',
                    'work': 'bg-blue-100 text-blue-700',
                    'private': 'bg-green-100 text-green-700',
                    'shopping': 'bg-purple-100 text-purple-700'
                }
                const categoryNames = {
                    'general': '一般',
                    'work': '仕事',
                    'private': 'プライベート',
                    'shopping': '買い物'
                }
                const priorityColors = {
                    3: 'bg-red-100 text-red-700',
                    2: 'bg-yellow-100 text-yellow-700', 
                    1: 'bg-green-100 text-green-700'
                }
                const priorityNames = { 3: '高', 2: '中', 1: '低' }
                
                // 期限判定
                const isOverdue = todo.due_date && new Date(todo.due_date) < new Date() && !todo.complete
                const dueDateStr = todo.due_date ? new Date(todo.due_date).toLocaleDateString('ja-JP') : ''
                
                const todoItem = document.createElement('div')
                todoItem.className = `flex items-center p-3 rounded-md ${isOverdue ? 'bg-red-50 border-l-4 border-red-400' : 'bg-gray-50'} cursor-move`
                todoItem.draggable = true
                todoItem.dataset.todoId = todo.id
                
                // ドラッグイベントを追加
                todoItem.addEventListener('dragstart', handleDragStart)
                todoItem.addEventListener('dragover', handleDragOver)
                todoItem.addEventListener('drop', handleDrop)
                todoItem.addEventListener('dragend', handleDragEnd)
                todoItem.innerHTML = `
                    <span class="px-2 py-1 text-xs rounded-full ${priorityColors[todo.priority] || priorityColors[2]} mr-2">
                        ${priorityNames[todo.priority] || '中'}
                    </span>
                    <span class="px-2 py-1 text-xs rounded-full ${categoryColors[todo.category] || categoryColors.general} mr-2">
                        ${categoryNames[todo.category] || 'その他'}
                    </span>
                    ${dueDateStr ? `<span class="px-2 py-1 text-xs rounded ${isOverdue ? 'bg-red-200 text-red-800' : 'bg-blue-100 text-blue-700'} mr-2">📅${dueDateStr}</span>` : ''}
                    <span class="flex-1 ${todo.complete ? 'line-through text-gray-500' : 'text-gray-800'}">${todo.title}</span>
                    <button onclick="editTodo(${todo.id})" 
                            class="ml-2 px-3 py-1 text-sm rounded bg-blue-500 hover:bg-blue-600 text-white"
                            draggable="false">
                        編集
                    </button>
                    <button onclick="toggleTodo(${todo.id}, ${!todo.complete})" 
                            class="ml-2 px-3 py-1 text-sm rounded ${todo.complete ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white"
                            draggable="false">
                        ${todo.complete ? '未完了' : '完了'}
                    </button>
                    <button onclick="deleteTodo(${todo.id})" 
                            class="ml-2 px-3 py-1 text-sm rounded bg-red-500 hover:bg-red-600 text-white"
                            draggable="false">
                        削除
                    </button>
                `
                todoList.appendChild(todoItem)
            })
        }

        // TODO完了/未完了切り替え関数
        async function toggleTodo(id, completed) {
            const { data, error } = await supabase
                .from('todos')
                .update({ complete: completed })
                .eq('id', id)
            
            if (error) {
                alert('エラー: ' + error.message)
            } else {
                loadTodos()
            }
        }

        // TODO削除関数
        async function deleteTodo(id) {
            if (!confirm('このTODOを削除しますか？')) {
                return
            }
            
            const { data, error } = await supabase
                .from('todos')
                .delete()
                .eq('id', id)
            
            if (error) {
                alert('エラー: ' + error.message)
            } else {
                loadTodos()
            }
        }
        
        // TODO編集モーダルを開く
        function editTodo(id) {
            const todo = allTodos.find(t => t.id === id)
            if (!todo) return
            
            editingTodoId = id
            
            // 現在の値をフォームに設定
            document.getElementById('edit-todo-title').value = todo.title
            document.getElementById('edit-todo-category').value = todo.category
            document.getElementById('edit-todo-priority').value = todo.priority
            document.getElementById('edit-todo-due-date').value = todo.due_date || ''
            
            // モーダルを表示
            document.getElementById('edit-todo-modal').classList.remove('hidden')
        }
        
        // TODO編集モーダルを閉じる
        function closeEditTodoModal() {
            document.getElementById('edit-todo-modal').classList.add('hidden')
            editingTodoId = null
            // メッセージをクリア
            document.getElementById('edit-todo-message').textContent = ''
        }
        
        // TODO更新関数
        async function updateTodo() {
            if (!editingTodoId) return
            
            const title = document.getElementById('edit-todo-title').value.trim()
            const category = document.getElementById('edit-todo-category').value
            const priority = parseInt(document.getElementById('edit-todo-priority').value)
            const dueDate = document.getElementById('edit-todo-due-date').value || null
            
            if (!title) {
                document.getElementById('edit-todo-message').textContent = 'タイトルを入力してください'
                document.getElementById('edit-todo-message').className = 'text-red-500 text-sm mb-4'
                return
            }
            
            const { data, error } = await supabase
                .from('todos')
                .update({
                    title: title,
                    category: category,
                    priority: priority,
                    due_date: dueDate
                })
                .eq('id', editingTodoId)
            
            if (error) {
                document.getElementById('edit-todo-message').textContent = 'エラー: ' + error.message
                document.getElementById('edit-todo-message').className = 'text-red-500 text-sm mb-4'
            } else {
                showNotification('TODO更新完了', 'success', 'TODOが更新されました')
                closeEditTodoModal()
                loadTodos()
            }
        }

        // 期間フィルター関数
        function filterByPeriod(period) {
            currentPeriod = period
            
            // ボタンのスタイルを更新
            document.querySelectorAll('.period-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.classList.add('bg-blue-100', 'border-blue-500')
                    btn.classList.remove('border-gray-300')
                } else {
                    btn.classList.remove('bg-blue-100', 'border-blue-500')
                    btn.classList.add('border-gray-300')
                }
            })
            
            // フィルターを適用
            filterTodos()
        }
        
        // 検索機能
        function filterTodos() {
            const searchText = document.getElementById('search-input').value.toLowerCase()
            const filterCategory = document.getElementById('filter-category').value
            const filterPriority = document.getElementById('filter-priority').value
            
            const filteredTodos = allTodos.filter(todo => {
                // テキスト検索
                const matchesSearch = todo.title.toLowerCase().includes(searchText)
                
                // カテゴリフィルタ
                const matchesCategory = !filterCategory || todo.category === filterCategory
                
                // 優先度フィルタ
                const matchesPriority = !filterPriority || todo.priority === parseInt(filterPriority)
                
                // 期間フィルタ
                let matchesPeriod = true
                if (currentPeriod !== 'all') {
                    const today = new Date()
                    today.setHours(0, 0, 0, 0)
                    const todoDate = new Date(todo.created_at)
                    
                    switch (currentPeriod) {
                        case 'today':
                            matchesPeriod = todoDate >= today
                            break
                        case 'week':
                            const weekAgo = new Date(today)
                            weekAgo.setDate(weekAgo.getDate() - 7)
                            matchesPeriod = todoDate >= weekAgo
                            break
                        case 'month':
                            const monthAgo = new Date(today)
                            monthAgo.setMonth(monthAgo.getMonth() - 1)
                            matchesPeriod = todoDate >= monthAgo
                            break
                    }
                }
                
                // すべての条件を満たすものだけを返す
                return matchesSearch && matchesCategory && matchesPriority && matchesPeriod
            })
            
            displayTodos(filteredTodos)
        }
        
        // ドラッグ開始処理
        function handleDragStart(event) {
            draggedTodoId = event.target.dataset.todoId
            event.target.style.opacity = '0.5'
        }
        
        // ドラッグオーバー処理（ドロップを許可）
        function handleDragOver(event) {
            event.preventDefault()
        }
        
        // ドロップ処理
        function handleDrop(event) {
            event.preventDefault()
            const dropTargetId = event.target.closest('[data-todo-id]').dataset.todoId
            
            if (draggedTodoId && dropTargetId && draggedTodoId !== dropTargetId) {
                // 配列内で位置を入れ替え
                swapTodoPositions(parseInt(draggedTodoId), parseInt(dropTargetId))
            }
        }
        
        // TODO位置入れ替え関数
        function swapTodoPositions(draggedId, targetId) {
            const draggedIndex = allTodos.findIndex(todo => todo.id === draggedId)
            const targetIndex = allTodos.findIndex(todo => todo.id === targetId)
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
                // 配列内で位置を交換
                [allTodos[draggedIndex], allTodos[targetIndex]] = [allTodos[targetIndex], allTodos[draggedIndex]]
                // 表示を更新
                displayTodos(allTodos)
            }
        }
        
        // ドラッグ終了処理
        function handleDragEnd(event) {
            event.target.style.opacity = '1'
            draggedTodoId = null
        }
        
        // ログインモーダルを開く
        function openLoginModal() {
            const modal = document.getElementById('login-modal')
            modal.classList.remove('hidden')
        }
        
        // ログインモーダルを閉じる
        function closeLoginModal() {
            const modal = document.getElementById('login-modal')
            modal.classList.add('hidden')
            // 入力内容をクリア
            document.getElementById('modal-email').value = ''
            document.getElementById('modal-password').value = ''
            document.getElementById('modal-message').textContent = ''
        }
        
        // モーダルからログイン
        async function modalSignIn() {
            const email = document.getElementById('modal-email').value
            const password = document.getElementById('modal-password').value
            
            if (!email || !password) {
                document.getElementById('modal-message').textContent = 'メールアドレスとパスワードを入力してください'
                document.getElementById('modal-message').className = 'text-red-500 text-sm mb-4'
                return
            }
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            })
            
            if (error) {
                document.getElementById('modal-message').textContent = 'エラー: ' + error.message
                document.getElementById('modal-message').className = 'text-red-500 text-sm mb-4'
            } else {
                closeLoginModal()
                showUserInfo(data.user)
            }
        }
        
        // モーダルからサインアップ
        async function modalSignUp() {
            const email = document.getElementById('modal-email').value
            const password = document.getElementById('modal-password').value
            
            if (!email || !password) {
                document.getElementById('modal-message').textContent = 'メールアドレスとパスワードを入力してください'
                document.getElementById('modal-message').className = 'text-red-500 text-sm mb-4'
                return
            }
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password
            })
            
            if (error) {
                document.getElementById('modal-message').textContent = 'エラー: ' + error.message
                document.getElementById('modal-message').className = 'text-red-500 text-sm mb-4'
            } else {
                document.getElementById('modal-message').textContent = 'サインアップ成功！メールを確認してください'
                document.getElementById('modal-message').className = 'text-green-500 text-sm mb-4'
            }
        }

        // ページ読み込み時にセッション確認
        window.addEventListener('load', async () => {
            // URLパラメータをチェック（パスワードリセットリンクから来たかどうか）
            const urlParams = new URLSearchParams(window.location.search)
            const accessToken = urlParams.get('access_token')
            const refreshToken = urlParams.get('refresh_token')
            const type = urlParams.get('type')
            
            // パスワードリセットの場合
            if (type === 'recovery' && accessToken && refreshToken) {
                try {
                    // セッションを設定
                    const { error } = await supabase.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    })
                    
                    if (!error) {
                        // パスワード更新フォームを表示
                        document.getElementById('reset-email-form').style.display = 'none'
                        document.getElementById('update-password-form').style.display = 'block'
                        openResetModal()
                    }
                } catch (err) {
                    console.error('セッション設定エラー:', err)
                }
            } else {
                // 通常のセッション確認
                const { data: { user } } = await supabase.auth.getUser()
                if (user) {
                    showUserInfo(user)
                }
            }
            
            // 検索ボックスにイベントリスナーを追加
            document.getElementById('search-input').addEventListener('input', filterTodos)
            document.getElementById('filter-category').addEventListener('change', filterTodos)
            document.getElementById('filter-priority').addEventListener('change', filterTodos)
            
            // Enterキーでログイン
            const emailInput = document.getElementById('email')
            const passwordInput = document.getElementById('password')
            
            const handleEnterKey = (event) => {
                if (event.key === 'Enter') {
                    signIn()
                }
            }
            
            emailInput.addEventListener('keypress', handleEnterKey)
            passwordInput.addEventListener('keypress', handleEnterKey)
            
            // アバター選択のイベントリスナー
            const avatarInput = document.getElementById('avatar-input')
            if (avatarInput) {
                avatarInput.addEventListener('change', handleAvatarSelection)
            }
            
            // 通知権限を要求
            requestNotificationPermission()
            
            // 初期表示で全期間ボタンをアクティブにする
            filterByPeriod('all')
        })
        
        // アバター画像選択処理
        function handleAvatarSelection(event) {
            const file = event.target.files[0]
            if (!file) return
            
            // ファイルサイズチェック（2MB）
            if (file.size > 2 * 1024 * 1024) {
                showProfileMessage('ファイルサイズは2MB以下にしてください', true)
                return
            }
            
            // ファイル形式チェック
            if (!file.type.startsWith('image/')) {
                showProfileMessage('画像ファイルを選択してください', true)
                return
            }
            
            // FileReaderでプレビュー表示
            const reader = new FileReader()
            reader.onload = function(e) {
                const previewImg = document.getElementById('profile-avatar-preview-img')
                const previewText = document.getElementById('profile-avatar-preview-text')
                
                previewImg.src = e.target.result
                previewImg.classList.remove('hidden')
                previewText.classList.add('hidden')
                
                // Base64データを保存（実際のプロダクションではSupabase Storageを使用）
                window.selectedAvatarData = e.target.result
                
                showProfileMessage('画像を選択しました！保存ボタンを押してください。', false)
                showNotification('アバター画像が選択されました', 'success')
            }
            reader.readAsDataURL(file)
        }
    </script>
    </div>
</body>
</html>